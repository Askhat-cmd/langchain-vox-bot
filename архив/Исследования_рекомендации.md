<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Решение проблемы производительности AI голосового бота на Asterisk

Проведен комплексный анализ архитектуры AI голосового бота и выявлены критические узкие места, приводящие к задержке ответа в 11+ секунд вместо целевых 2-3 секунд. Основная проблема с функцией `_max_relevance()` (6.4+ сек) уже решена, но остались другие критические проблемы производительности.

![Анализ узких мест производительности AI голосового бота](https://ppl-ai-code-interpreter-files.s3.amazonaws.com/web/direct-files/78832ff91a57fed93c0017245b995f8e/a23c0451-9b99-4290-9e62-9e6daa7d52c1/1bf14c38.png)

Анализ узких мест производительности AI голосового бота

## Выявленные критические проблемы

Анализ логов и кода показал следующие узкие места:

**1. AI Streaming занимает 9.5 секунд** - наиболее критичная проблема, связанная с множественными запросами к OpenAI API и неоптимальной обработкой RAG pipeline. В логах видно, что AI агент делает несколько embedding запросов подряд, что значительно увеличивает время обработки.[^1][^2]

**2. gRPC TTS не работает** - система падает на HTTP fallback (0.5 сек вместо 0.1 сек), из-за ошибки импорта: "module 'yandex.cloud.ai.tts.v3.tts_service_pb2' has no attribute 'UtteranceSynthesisRequest'". Это указывает на некорректно сгенерированные proto файлы.[^3][^4]

**3. Множественные embedding запросы** - ChromaDB выполняет 3-4 запроса к OpenAI embeddings API для каждого пользовательского запроса. Каждый запрос занимает 0.5-1 секунду, что в сумме дает 2+ секунды дополнительной задержки.[^2][^5]

**4. Устаревшая версия ChromaDB** - система использует deprecated `langchain-community.vectorstores.Chroma` вместо новой `langchain-chroma`, что приводит к предупреждениям и субоптимальной производительности.[^6][^7]

![Архитектура AI голосового бота с временными метриками](https://ppl-ai-code-interpreter-files.s3.amazonaws.com/web/direct-files/78832ff91a57fed93c0017245b995f8e/23c99fe2-fd2b-4f31-8c5b-154896c10345/56b9cd15.png)

Архитектура AI голосового бота с временными метриками

## Приоритизированный план оптимизации

Разработан поэтапный план исправлений, который позволит сократить время ответа до 2-3 секунд:

### Критичные исправления (экономия 7 сек)

- **Redis кеширование embeddings** - предотвратит повторные запросы к OpenAI API
- **Оптимизация RAG pipeline** - устранение множественных LLM запросов и оптимизация промптов


### Высокоприоритетные исправления (экономия 2.4 сек)

- **Исправление gRPC TTS** - восстановление быстрого синтеза речи
- **Устранение fallback логики** - упрощение цепочки обработки


### Среднеприоритетные улучшения (экономия 0.7 сек)

- **Обновление ChromaDB** до актуальной версии
- **Детальное профилирование** для мониторинга производительности


## Готовые исправления кода

Подготовлены конкретные исправления для ключевых файлов:

**agent.py** - добавление Redis кеширования и оптимизация RAG запросов. Кеширование embeddings позволит избежать повторных дорогостоящих запросов к OpenAI API.[^8][^9]

**yandex_tts_service.py** - исправление импортов gRPC модулей и корректная обработка `UtteranceSynthesisRequest`. Это восстановит работу быстрого gRPC TTS вместо медленного HTTP fallback.

**stasis_handler.py** - добавление детального профилирования всех этапов обработки для контроля производительности в реальном времени.

## Технические рекомендации

Для успешной реализации оптимизаций необходимо:

1. **Установить Redis** для кеширования - `sudo apt-get install redis-server`
2. **Обновить зависимости** - заменить `langchain-community` на `langchain-chroma`
3. **Перегенерировать proto файлы** - `python -m grpc_tools.protoc --python_out=. *.proto`
4. **Поэтапное тестирование** - применять исправления по одному для контроля результата

## Ожидаемый результат

После применения всех оптимизаций:

- **Общее время ответа**: с 9.5 сек до 2-3 сек (3x ускорение)
- **AI Streaming**: с 9.5 сек до 2 сек
- **TTS**: восстановление gRPC (0.1 сек вместо 0.5 сек)
- **Кеш-попадания**: 80%+ для повторных запросов
- **Стабильность**: устранение Channel not found ошибок

Реализация критичных исправлений займет 4-6 часов и обеспечит возврат к производительности уровня Voximplant версии. Система получит детальное профилирование для предотвращения будущих проблем производительности.[^10][^11][^12]

____

