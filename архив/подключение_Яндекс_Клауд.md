# –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Yandex SpeechKit –∫ Asterisk –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞



## –≠—Ç–∞–ø 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Yandex Cloud (15-20 –º–∏–Ω—É—Ç)

### 1.1 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Yandex Cloud
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [cloud.yandex.ru](https://cloud.yandex.ru)
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —Å –ø–æ–º–æ—â—å—é –≤–∞—à–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ø–Ω–¥–µ–∫—Å –ø–æ—á—Ç—ã
3. –ù–∞–∂–º–∏—Ç–µ **"–í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å"** –∏–ª–∏ **"–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ"**
4. –°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞, –Ω–æ —Å–ø–∏—Å–∞–Ω–∏–π –Ω–µ –±—É–¥–µ—Ç - –ø–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚ÇΩ4000 –Ω–∞ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥)[1][2]

### 1.2 –°–æ–∑–¥–∞–Ω–∏–µ –æ–±–ª–∞–∫–∞ –∏ –∫–∞—Ç–∞–ª–æ–≥–∞
1. –í –∫–æ–Ω—Å–æ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ **"–°–æ–∑–¥–∞—Ç—å –æ–±–ª–∞–∫–æ"**
2. –£–∫–∞–∂–∏—Ç–µ –∏–º—è –æ–±–ª–∞–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "asterisk-cloud")
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç—Å—è –∫–∞—Ç–∞–ª–æ–≥ `default`
4. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ ID –∫–∞—Ç–∞–ª–æ–≥–∞** - –Ω–∞–π–¥–∏—Ç–µ –µ–≥–æ –≤ URL: `https://console.cloud.yandex.ru/folders/b1gd129pp9ha0vnvf5g7`, –≥–¥–µ `b1gd129pp9ha0vnvf5g7` - —ç—Ç–æ –≤–∞—à **folder_id**[3][4]

### 1.3 –ü–æ–ª—É—á–µ–Ω–∏–µ OAuth-—Ç–æ–∫–µ–Ω–∞
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: [oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb](https://oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb)
2. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑—Ä–µ—à–∏—Ç—å"**
3. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π OAuth-—Ç–æ–∫–µ–Ω** - –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ IAM-—Ç–æ–∫–µ–Ω–æ–≤[5][1]

## –≠—Ç–∞–ø 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CLI –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (10 –º–∏–Ω—É—Ç)

### 2.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Yandex Cloud CLI
```bash
# –î–ª—è Ubuntu/Debian
curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
source ~/.bashrc

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CLI
yc init
```

### 2.2 –ü–æ–ª—É—á–µ–Ω–∏–µ IAM-—Ç–æ–∫–µ–Ω–∞
```bash
# –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - —á–µ—Ä–µ–∑ CLI
yc iam create-token

# –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
export IAM_TOKEN=$(yc iam create-token)
echo $IAM_TOKEN
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ**: IAM-—Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ 12 —á–∞—Å–æ–≤, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è[6][1]

## –≠—Ç–∞–ø 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Asterisk (20-30 –º–∏–Ω—É—Ç)

### 3.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π EAGI
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Asterisk —Å–æ–±—Ä–∞–Ω —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π EAGI
asterisk -x "core show version"
asterisk -x "module show like app_eagi"
```

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ**: –ï—Å–ª–∏ Asterisk –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ Ubuntu –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç EAGI –ø–æ—Ç–æ–∫–∏, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤[7]

### 3.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–ø–∫–∏ AGI
–í —Ñ–∞–π–ª–µ `/etc/asterisk/asterisk.conf` –∏–∑–º–µ–Ω–∏—Ç–µ –ø—É—Ç—å –∫ AGI —Å–∫—Ä–∏–ø—Ç–∞–º:
```ini
[directories]
agidir => /var/lib/asterisk/agi-bin
```

### 3.3 –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —ç–∫—Å—Ç–µ–Ω—à–µ–Ω–∞
–í —Ñ–∞–π–ª–µ `/etc/asterisk/extensions.conf` –¥–æ–±–∞–≤—å—Ç–µ:
```ini
[from-internal]
; –¢–µ—Å—Ç Yandex SpeechKit
exten => 444,1,Answer()
exten => 444,n,Wait(1)
exten => 444,n,EAGI(yandex_streaming.py)
exten => 444,n,NoOp(–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: ${TEXT})
exten => 444,n,Hangup()
```

## –≠—Ç–∞–ø 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (10 –º–∏–Ω—É—Ç)

### 4.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ pip (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
sudo apt update
sudo apt install python3 python3-pip

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è SpeechKit
pip3 install grpcio grpcio-tools requests
pip3 install pyst2  # –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Asterisk AGI

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API SpeechKit
cd /var/lib/asterisk/agi-bin/
sudo git clone https://github.com/yandex-cloud/cloudapi.git
cd cloudapi && sudo python3 -m grpc_tools.protoc -I . -I third_party/googleapis \
  --python_out=. --grpc_python_out=. yandex/cloud/ai/stt/v2/stt_service.proto
```

## –≠—Ç–∞–ø 5: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (30-40 –º–∏–Ω—É—Ç)

### 5.1 –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç `/var/lib/asterisk/agi-bin/yandex_streaming.py`
```python
#!/usr/bin/python3
# -*- coding: utf-8 -*-

import sys
import os
import grpc
import requests
from asterisk.agi import AGI

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ cloudapi
sys.path.append('/var/lib/asterisk/agi-bin/cloudapi')

import yandex.cloud.ai.stt.v2.stt_service_pb2 as stt_service_pb2
import yandex.cloud.ai.stt.v2.stt_service_pb2_grpc as stt_service_pb2_grpc

# –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è!
FOLDER_ID = "–≤–∞—à_folder_id_–∏–∑_–∫–æ–Ω—Å–æ–ª–∏"
OAUTH_TOKEN = "–≤–∞—à_oauth_—Ç–æ–∫–µ–Ω"

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è IAM-—Ç–æ–∫–µ–Ω–∞
def get_iam_token(oauth_token):
    url = "https://iam.api.cloud.yandex.net/iam/v1/tokens"
    headers = {"Content-Type": "application/json"}
    data = {"yandexPassportOauthToken": oauth_token}
    
    response = requests.post(url, headers=headers, json=data)
    if response.status_code == 200:
        return response.json()["iamToken"]
    else:
        raise Exception(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IAM-—Ç–æ–∫–µ–Ω–∞: {response.text}")

# –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞
def gen_audio_stream(folder_id, agi):
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    specification = stt_service_pb2.RecognitionSpec(
        language_code='ru-RU',
        profanity_filter=True,
        model='general',
        partial_results=True,
        audio_encoding='LINEAR16_PCM',
        sample_rate_hertz=8000
    )
    
    streaming_config = stt_service_pb2.RecognitionConfig(
        specification=specification, 
        folder_id=folder_id
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    yield stt_service_pb2.StreamingRecognitionRequest(config=streaming_config)
    
    # –ß–∏—Ç–∞–µ–º –∞—É–¥–∏–æ –∏–∑ file descriptor 3 (EAGI)
    CHUNK_SIZE = 4000
    with os.fdopen(3, 'rb') as audio_file:
        while True:
            chunk = audio_file.read(CHUNK_SIZE)
            if not chunk:
                break
            yield stt_service_pb2.StreamingRecognitionRequest(audio_content=chunk)

# –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏
def synthesize_speech(text, iam_token, folder_id):
    url = 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize'
    headers = {'Authorization': f'Bearer {iam_token}'}
    
    data = {
        'text': text,
        'lang': 'ru-RU',
        'folderId': folder_id,
        'sampleRateHertz': '8000',
        'format': 'lpcm',
        'voice': 'oksana'
    }
    
    response = requests.post(url, headers=headers, data=data, stream=True)
    if response.status_code == 200:
        return response.content
    else:
        raise Exception(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞: {response.text}")

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    agi = AGI()
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º IAM-—Ç–æ–∫–µ–Ω
        iam_token = get_iam_token(OAUTH_TOKEN)
        agi.verbose(f"IAM —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gRPC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        cred = grpc.ssl_channel_credentials()
        channel = grpc.secure_channel('stt.api.cloud.yandex.net:443', cred)
        stub = stt_service_pb2_grpc.SttServiceStub(channel)
        
        # –ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
        agi.verbose("–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ...")
        
        metadata = (('authorization', f'Bearer {iam_token}'),)
        responses = stub.StreamingRecognize(gen_audio_stream(FOLDER_ID, agi), metadata=metadata)
        
        recognized_text = ""
        
        for response in responses:
            try:
                if response.chunks:
                    for chunk in response.chunks:
                        if chunk.alternatives:
                            for alternative in chunk.alternatives:
                                if chunk.final:
                                    recognized_text = alternative.text
                                    agi.verbose(f"–§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢: {recognized_text}")
                                else:
                                    agi.verbose(f"–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π: {alternative.text}")
            except Exception as e:
                agi.verbose(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è Asterisk
        agi.set_variable("TEXT", recognized_text)
        
        # –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç
        if recognized_text:
            response_text = f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {recognized_text}"
            audio_data = synthesize_speech(response_text, iam_token, FOLDER_ID)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—É–¥–∏–æ
            audio_path = f"/tmp/response_{agi.env['agi_uniqueid']}.raw"
            with open(audio_path, 'wb') as f:
                f.write(audio_data)
            
            # –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è .raw)
            agi.stream_file(audio_path.replace('.raw', ''))
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            os.remove(audio_path)
        
    except Exception as e:
        agi.verbose(f"–û–®–ò–ë–ö–ê: {e}")
        agi.say_digits("500")  # –°–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ

if __name__ == '__main__':
    main()
```

### 5.2 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```bash
sudo chmod +x /var/lib/asterisk/agi-bin/yandex_streaming.py
sudo chown asterisk:asterisk /var/lib/asterisk/agi-bin/yandex_streaming.py
```

## –≠—Ç–∞–ø 6: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (15 –º–∏–Ω—É—Ç)

### 6.1 –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IAM-—Ç–æ–∫–µ–Ω–∞
–°–æ–∑–¥–∞–π—Ç–µ `/var/lib/asterisk/agi-bin/update_iam_token.py`:
```python
#!/usr/bin/python3
import requests
import json
import os

OAUTH_TOKEN = "–≤–∞—à_oauth_—Ç–æ–∫–µ–Ω"
TOKEN_FILE = "/tmp/yandex_iam_token.json"

def update_iam_token():
    url = "https://iam.api.cloud.yandex.net/iam/v1/tokens"
    data = {"yandexPassportOauthToken": OAUTH_TOKEN}
    
    response = requests.post(url, json=data)
    if response.status_code == 200:
        token_data = response.json()
        with open(TOKEN_FILE, 'w') as f:
            json.dump(token_data, f)
        print("IAM —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω")
    else:
        print(f"–û—à–∏–±–∫–∞: {response.text}")

if __name__ == "__main__":
    update_iam_token()
```

### 6.2 Cron –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
```bash
sudo crontab -e
# –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É:
0 */6 * * * /usr/bin/python3 /var/lib/asterisk/agi-bin/update_iam_token.py
```

## –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (10 –º–∏–Ω—É—Ç)

### 7.1 –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Asterisk
```bash
sudo systemctl restart asterisk
sudo asterisk -r
asterisk> dialplan reload
asterisk> module reload
```

### 7.2 –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
1. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä **444** —Å –ª—é–±–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
2. –ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ —Ñ—Ä–∞–∑—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
3. –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–æ, —á—Ç–æ –≤—ã —Å–∫–∞–∑–∞–ª–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo tail -f /var/log/asterisk/messages`

## –≠—Ç–∞–ø 8: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 8.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–í `/etc/asterisk/logger.conf` –¥–æ–±–∞–≤—å—Ç–µ:
```ini
[logfiles]
speechkit => notice,warning,error,debug,verbose(5)
```

### 8.2 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞—Å—Ö–æ–¥–æ–≤
- –ó–∞—Ö–æ–¥–∏—Ç–µ –≤ [–∫–æ–Ω—Å–æ–ª—å Yandex Cloud](https://console.cloud.yandex.ru)
- –†–∞–∑–¥–µ–ª "–ë–∏–ª–ª–∏–Ω–≥" ‚Üí "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è"
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ SpeechKit

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

**1. Asterisk –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç EAGI –ø–æ—Ç–æ–∫–∏**[7]
- –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Asterisk –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ —Å –≤–∫–ª—é—á–µ–Ω–∏–µ–º EAGI

**2. –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å OAuth-—Ç–æ–∫–µ–Ω–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ IAM-—Ç–æ–∫–µ–Ω —Å–≤–µ–∂–∏–π (–Ω–µ —Å—Ç–∞—Ä—à–µ 12 —á–∞—Å–æ–≤)

**3. –ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–æ–º**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ 8000 Hz
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥–µ–∫ –∫–∞–Ω–∞–ª–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ULAW –∏–ª–∏ ALAW)

**–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å**: –ü—Ä–∏ 10,000 –º–∏–Ω—É—Ç –≤ –º–µ—Å—è—Ü - –æ–∫–æ–ª–æ 6,400 ‚ÇΩ[8]

**–ó–∞–¥–µ—Ä–∂–∫–∞**: –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ - 1.0-1.5 —Å–µ–∫—É–Ω–¥—ã[7]

–≠—Ç–æ—Ç –ø–ª–∞–Ω –ø–æ–∑–≤–æ–ª–∏—Ç –≤–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Yandex SpeechKit —Å Asterisk –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ —Å–∏–Ω—Ç–µ–∑–∞ —Ä—É—Å—Å–∫–æ–π —Ä–µ—á–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏.


–ü–†–û–î–û–õ–ñ–ï–ù–ò–ï:

–í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã! –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–±–∞–≤—è—Ç –≤–∞—Å –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥. –í–æ—Ç **–≥–æ—Ç–æ–≤—ã–µ** —Ä–µ—à–µ–Ω–∏—è:

## üéØ –ì–æ—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è Yandex SpeechKit + Asterisk

### 1. –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å Habr (2023 –≥–æ–¥)

**–ê–≤—Ç–æ—Ä**: —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å –Ω–∏–∫–æ–º –Ω–∞ Habr, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–µ–µ —Ä–µ—à–µ–Ω–∏–µ[1]

**–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø–∞–∫–µ—Ç**:
- –ì–æ—Ç–æ–≤—ã–π Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è EAGI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Asterisk
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ

**–°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ**:
```bash
# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ Yandex CloudAPI
git clone https://github.com/yandex-cloud/cloudapi.git
cd cloudapi

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º proto —Ñ–∞–π–ª—ã
python3 -m grpc_tools.protoc -I . -I third_party/googleapis \
  --python_out=. --grpc_python_out=. \
  yandex/cloud/ai/stt/v2/stt_service.proto
```

**–ì–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç** (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º):
```python
#!/usr/bin/python3.6
#coding=utf8
import argparse
from asterisk.agi import *
import requests
import grpc
import os
import yandex.cloud.ai.stt.v2.stt_service_pb2 as stt_service_pb2
import yandex.cloud.ai.stt.v2.stt_service_pb2_grpc as stt_service_pb2_grpc

agi = AGI()
CHUNK_SIZE = 4000

# –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò –î–ê–ù–ù–´–ï:
folder = "–≤–∞—à_folder_id"
token = "–≤–∞—à_iam_token"

def gen(folder_id):
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    specification = stt_service_pb2.RecognitionSpec(
        language_code='ru-RU',
        profanity_filter=True,
        model='general',
        partial_results=True,
        audio_encoding='LINEAR16_PCM',
        sample_rate_hertz=8000
    )
    
    streaming_config = stt_service_pb2.RecognitionConfig(
        specification=specification, 
        folder_id=folder_id
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    yield stt_service_pb2.StreamingRecognitionRequest(config=streaming_config)
    
    # –ß–∏—Ç–∞–µ–º –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ EAGI (file descriptor 3)
    with os.fdopen(3, 'rb') as f:
        data = f.read(CHUNK_SIZE)
        while data != b'':
            yield stt_service_pb2.StreamingRecognitionRequest(audio_content=data)
            data = f.read(CHUNK_SIZE)

def run(folder_id, iam_token):
    # gRPC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    cred = grpc.ssl_channel_credentials()
    channel = grpc.secure_channel('stt.api.cloud.yandex.net:443', cred)
    stub = stt_service_pb2_grpc.SttServiceStub(channel)
    
    # –ü–æ—Ç–æ–∫–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
    it = stub.StreamingRecognize(
        gen(folder_id), 
        metadata=(('authorization', 'Bearer %s' % iam_token),)
    )
    
    try:
        for r in it:
            try:
                for alternative in r.chunks[0].alternatives:
                    agi.verbose(alternative.text)
                    
                    if r.chunks[0].final:
                        agi.verbose("–§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢")
                        
                        # –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                        with open("/tmp/response.raw", "wb") as f:
                            for audio_content in synthesize(alternative.text):
                                f.write(audio_content)
                        
                        # –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
                        agi.stream_file("/tmp/response")
                        
            except LookupError:
                agi.verbose('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞–Ω–∫–æ–≤')
                
    except grpc._channel._Rendezvous as err:
        agi.verbose('gRPC Error: %s' % err._state.details)

def synthesize(text):
    url = 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize'
    headers = {'Authorization': 'Bearer ' + token}
    
    data = {
        'text': text,
        'lang': 'ru-RU',
        'folderId': folder,
        'sampleRateHertz': '8000',
        'format': 'lpcm'
    }
    
    with requests.post(url, headers=headers, data=data, stream=True) as resp:
        if resp.status_code != 200:
            raise RuntimeError("TTS Error: %s" % resp.text)
        
        for chunk in resp.iter_content(chunk_size=None):
            yield chunk

if __name__ == '__main__':
    run(folder, token)
```

### 2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≥–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

#### Google Speech –¥–ª—è Asterisk (–∞–¥–∞–ø—Ç–∏—Ä—É–µ–º—ã–π –ø–æ–¥ Yandex)

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: https://github.com/zaf/asterisk-speech-recog[2]

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- 132 —Ñ–æ—Ä–∫–∞, –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
- Perl-—Å–∫—Ä–∏–ø—Ç, –ª–µ–≥–∫–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ Yandex API
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ `ru-RU`

#### Vosk + Asterisk (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: https://github.com/alphacep/vosk-asterisk[3]

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –ú–æ–¥—É–ª–∏ –¥–ª—è –ø—Ä—è–º–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Asterisk
- 120 –∑–≤–µ–∑–¥, –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

## üöÄ –≠–∫—Å–ø—Ä–µ—Å—Å-—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è (10 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (2 –º–∏–Ω—É—Ç—ã)
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt install python3-pip
pip3 install pyst2 grpcio grpcio-tools requests

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –ø–∞–ø–∫–∏
sudo mkdir -p /var/lib/asterisk/agi-bin/yandex
cd /var/lib/asterisk/agi-bin/yandex
```

### –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∞ (3 –º–∏–Ω—É—Ç—ã)
```bash
# –ö–ª–æ–Ω–∏—Ä—É–µ–º CloudAPI
sudo git clone https://github.com/yandex-cloud/cloudapi.git

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
cd cloudapi
sudo python3 -m grpc_tools.protoc -I . -I third_party/googleapis \
    --python_out=. --grpc_python_out=. \
    yandex/cloud/ai/stt/v2/stt_service.proto

# –ö–æ–ø–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –∏–∑ Habr
sudo wget -O ../yandex_speech.py "—Å—Å—ã–ª–∫–∞_–Ω–∞_–≥–æ—Ç–æ–≤—ã–π_—Å–∫—Ä–∏–ø—Ç"
sudo chmod +x ../yandex_speech.py
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Asterisk (3 –º–∏–Ω—É—Ç—ã)
```bash
# –î–æ–±–∞–≤–ª—è–µ–º –≤ /etc/asterisk/extensions.conf
echo "
[from-internal]
exten => 444,1,Answer()
exten => 444,n,EAGI(yandex/yandex_speech.py)
exten => 444,n,Hangup()
" | sudo tee -a /etc/asterisk/extensions.conf

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Asterisk
sudo systemctl reload asterisk
```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (2 –º–∏–Ω—É—Ç—ã)
```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç
sudo nano /var/lib/asterisk/agi-bin/yandex/yandex_speech.py

# –ó–∞–º–µ–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏:
# folder = "–≤–∞—à_folder_id_–∏–∑_yandex_console"  
# token = "–≤–∞—à_iam_token_–∏–∑_yandex_console"
```


## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π

**–ò–∑ —Å—Ç–∞—Ç—å–∏ –Ω–∞ Habr**:[1]
> "Asterisk —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ–º—ã–π –≤ Ubuntu —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç EAGI –ø–æ—Ç–æ–∫–∏. –ü–æ–ª—É—á–∏–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ —Å –≤–∫–ª—é—á–µ–Ω–∏–µ–º EAGI –ø–æ—Ç–æ–∫–æ–≤ –≤ menuconfig"

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Å–±–æ—Ä–∫–∏ Asterisk —Å EAGI –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤.

