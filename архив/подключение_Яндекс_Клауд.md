# Пошаговый план подключения Yandex SpeechKit к Asterisk для потокового режима



## Этап 1: Настройка Yandex Cloud (15-20 минут)

### 1.1 Регистрация в Yandex Cloud
1. Перейдите на [cloud.yandex.ru](https://cloud.yandex.ru)
2. Авторизуйтесь с помощью вашей существующей Яндекс почты
3. Нажмите **"Войти в консоль"** или **"Попробовать бесплатно"**
4. Создайте платежный аккаунт (потребуется карта, но списаний не будет - получите бесплатно ₽4000 на пробный период)[1][2]

### 1.2 Создание облака и каталога
1. В консоли управления нажмите на **"Создать облако"**
2. Укажите имя облака (например, "asterisk-cloud")
3. Автоматически создастся каталог `default`
4. **Сохраните ID каталога** - найдите его в URL: `https://console.cloud.yandex.ru/folders/b1gd129pp9ha0vnvf5g7`, где `b1gd129pp9ha0vnvf5g7` - это ваш **folder_id**[3][4]

### 1.3 Получение OAuth-токена
1. Перейдите по ссылке: [oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb](https://oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb)
2. Нажмите **"Разрешить"**
3. **Скопируйте полученный OAuth-токен** - он понадобится для генерации IAM-токенов[5][1]

## Этап 2: Установка CLI и настройка (10 минут)

### 2.1 Установка Yandex Cloud CLI
```bash
# Для Ubuntu/Debian
curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
source ~/.bashrc

# Инициализация CLI
yc init
```

### 2.2 Получение IAM-токена
```bash
# Простой способ - через CLI
yc iam create-token

# Сохраните токен в переменную для удобства
export IAM_TOKEN=$(yc iam create-token)
echo $IAM_TOKEN
```

**⚠️ Важно**: IAM-токен действует только 12 часов, поэтому нужна автоматическая генерация[6][1]

## Этап 3: Подготовка Asterisk (20-30 минут)

### 3.1 Проверка возможностей EAGI
```bash
# Убедитесь, что Asterisk собран с поддержкой EAGI
asterisk -x "core show version"
asterisk -x "module show like app_eagi"
```

**⚠️ Критично**: Если Asterisk из репозиториев Ubuntu не поддерживает EAGI потоки, потребуется пересборка из исходников[7]

### 3.2 Настройка папки AGI
В файле `/etc/asterisk/asterisk.conf` измените путь к AGI скриптам:
```ini
[directories]
agidir => /var/lib/asterisk/agi-bin
```

### 3.3 Создание тестового экстеншена
В файле `/etc/asterisk/extensions.conf` добавьте:
```ini
[from-internal]
; Тест Yandex SpeechKit
exten => 444,1,Answer()
exten => 444,n,Wait(1)
exten => 444,n,EAGI(yandex_streaming.py)
exten => 444,n,NoOp(Распознанный текст: ${TEXT})
exten => 444,n,Hangup()
```

## Этап 4: Установка Python зависимостей (10 минут)

### 4.1 Установка необходимых пакетов
```bash
# Установка Python и pip (если не установлен)
sudo apt update
sudo apt install python3 python3-pip

# Установка зависимостей для SpeechKit
pip3 install grpcio grpcio-tools requests
pip3 install pyst2  # для работы с Asterisk AGI

# Клонирование API SpeechKit
cd /var/lib/asterisk/agi-bin/
sudo git clone https://github.com/yandex-cloud/cloudapi.git
cd cloudapi && sudo python3 -m grpc_tools.protoc -I . -I third_party/googleapis \
  --python_out=. --grpc_python_out=. yandex/cloud/ai/stt/v2/stt_service.proto
```

## Этап 5: Создание скрипта интеграции (30-40 минут)

### 5.1 Основной скрипт `/var/lib/asterisk/agi-bin/yandex_streaming.py`
```python
#!/usr/bin/python3
# -*- coding: utf-8 -*-

import sys
import os
import grpc
import requests
from asterisk.agi import AGI

# Добавляем путь к cloudapi
sys.path.append('/var/lib/asterisk/agi-bin/cloudapi')

import yandex.cloud.ai.stt.v2.stt_service_pb2 as stt_service_pb2
import yandex.cloud.ai.stt.v2.stt_service_pb2_grpc as stt_service_pb2_grpc

# ВАЖНО: Замените на ваши реальные значения!
FOLDER_ID = "ваш_folder_id_из_консоли"
OAUTH_TOKEN = "ваш_oauth_токен"

# Функция получения IAM-токена
def get_iam_token(oauth_token):
    url = "https://iam.api.cloud.yandex.net/iam/v1/tokens"
    headers = {"Content-Type": "application/json"}
    data = {"yandexPassportOauthToken": oauth_token}
    
    response = requests.post(url, headers=headers, json=data)
    if response.status_code == 200:
        return response.json()["iamToken"]
    else:
        raise Exception(f"Ошибка получения IAM-токена: {response.text}")

# Генератор аудиопотока
def gen_audio_stream(folder_id, agi):
    # Настройки распознавания
    specification = stt_service_pb2.RecognitionSpec(
        language_code='ru-RU',
        profanity_filter=True,
        model='general',
        partial_results=True,
        audio_encoding='LINEAR16_PCM',
        sample_rate_hertz=8000
    )
    
    streaming_config = stt_service_pb2.RecognitionConfig(
        specification=specification, 
        folder_id=folder_id
    )
    
    # Отправляем конфигурацию
    yield stt_service_pb2.StreamingRecognitionRequest(config=streaming_config)
    
    # Читаем аудио из file descriptor 3 (EAGI)
    CHUNK_SIZE = 4000
    with os.fdopen(3, 'rb') as audio_file:
        while True:
            chunk = audio_file.read(CHUNK_SIZE)
            if not chunk:
                break
            yield stt_service_pb2.StreamingRecognitionRequest(audio_content=chunk)

# Синтез речи
def synthesize_speech(text, iam_token, folder_id):
    url = 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize'
    headers = {'Authorization': f'Bearer {iam_token}'}
    
    data = {
        'text': text,
        'lang': 'ru-RU',
        'folderId': folder_id,
        'sampleRateHertz': '8000',
        'format': 'lpcm',
        'voice': 'oksana'
    }
    
    response = requests.post(url, headers=headers, data=data, stream=True)
    if response.status_code == 200:
        return response.content
    else:
        raise Exception(f"Ошибка синтеза: {response.text}")

# Основная функция
def main():
    agi = AGI()
    
    try:
        # Получаем IAM-токен
        iam_token = get_iam_token(OAUTH_TOKEN)
        agi.verbose(f"IAM токен получен успешно")
        
        # Устанавливаем gRPC соединение
        cred = grpc.ssl_channel_credentials()
        channel = grpc.secure_channel('stt.api.cloud.yandex.net:443', cred)
        stub = stt_service_pb2_grpc.SttServiceStub(channel)
        
        # Начинаем потоковое распознавание
        agi.verbose("Начинаем распознавание...")
        
        metadata = (('authorization', f'Bearer {iam_token}'),)
        responses = stub.StreamingRecognize(gen_audio_stream(FOLDER_ID, agi), metadata=metadata)
        
        recognized_text = ""
        
        for response in responses:
            try:
                if response.chunks:
                    for chunk in response.chunks:
                        if chunk.alternatives:
                            for alternative in chunk.alternatives:
                                if chunk.final:
                                    recognized_text = alternative.text
                                    agi.verbose(f"ФИНАЛЬНЫЙ РЕЗУЛЬТАТ: {recognized_text}")
                                else:
                                    agi.verbose(f"Промежуточный: {alternative.text}")
            except Exception as e:
                agi.verbose(f"Ошибка обработки: {e}")
        
        # Устанавливаем переменную для Asterisk
        agi.set_variable("TEXT", recognized_text)
        
        # Синтезируем и воспроизводим ответ
        if recognized_text:
            response_text = f"Вы сказали: {recognized_text}"
            audio_data = synthesize_speech(response_text, iam_token, FOLDER_ID)
            
            # Сохраняем аудио
            audio_path = f"/tmp/response_{agi.env['agi_uniqueid']}.raw"
            with open(audio_path, 'wb') as f:
                f.write(audio_data)
            
            # Воспроизводим (без расширения .raw)
            agi.stream_file(audio_path.replace('.raw', ''))
            
            # Удаляем временный файл
            os.remove(audio_path)
        
    except Exception as e:
        agi.verbose(f"ОШИБКА: {e}")
        agi.say_digits("500")  # Сообщаем об ошибке

if __name__ == '__main__':
    main()
```

### 5.2 Установка прав доступа
```bash
sudo chmod +x /var/lib/asterisk/agi-bin/yandex_streaming.py
sudo chown asterisk:asterisk /var/lib/asterisk/agi-bin/yandex_streaming.py
```

## Этап 6: Автоматизация обновления токена (15 минут)

### 6.1 Скрипт для автообновления IAM-токена
Создайте `/var/lib/asterisk/agi-bin/update_iam_token.py`:
```python
#!/usr/bin/python3
import requests
import json
import os

OAUTH_TOKEN = "ваш_oauth_токен"
TOKEN_FILE = "/tmp/yandex_iam_token.json"

def update_iam_token():
    url = "https://iam.api.cloud.yandex.net/iam/v1/tokens"
    data = {"yandexPassportOauthToken": OAUTH_TOKEN}
    
    response = requests.post(url, json=data)
    if response.status_code == 200:
        token_data = response.json()
        with open(TOKEN_FILE, 'w') as f:
            json.dump(token_data, f)
        print("IAM токен обновлен")
    else:
        print(f"Ошибка: {response.text}")

if __name__ == "__main__":
    update_iam_token()
```

### 6.2 Cron для автообновления каждые 6 часов
```bash
sudo crontab -e
# Добавьте строку:
0 */6 * * * /usr/bin/python3 /var/lib/asterisk/agi-bin/update_iam_token.py
```

## Этап 7: Тестирование (10 минут)

### 7.1 Перезагрузка Asterisk
```bash
sudo systemctl restart asterisk
sudo asterisk -r
asterisk> dialplan reload
asterisk> module reload
```

### 7.2 Проведение тестового звонка
1. Позвоните на номер **444** с любого телефона
2. Произнесите фразу на русском языке
3. Система должна повторить то, что вы сказали
4. Проверьте логи: `sudo tail -f /var/log/asterisk/messages`

## Этап 8: Оптимизация и мониторинг

### 8.1 Настройка логирования
В `/etc/asterisk/logger.conf` добавьте:
```ini
[logfiles]
speechkit => notice,warning,error,debug,verbose(5)
```

### 8.2 Мониторинг расходов
- Заходите в [консоль Yandex Cloud](https://console.cloud.yandex.ru)
- Раздел "Биллинг" → "Детализация"
- Отслеживайте потребление SpeechKit

## Возможные проблемы и решения

**1. Asterisk не поддерживает EAGI потоки**[7]
- Пересоберите Asterisk из исходников с включением EAGI

**2. Ошибки авторизации**
- Проверьте правильность OAuth-токена
- Убедитесь, что IAM-токен свежий (не старше 12 часов)

**3. Проблемы с аудиоформатом**
- Убедитесь, что частота дискретизации 8000 Hz
- Проверьте кодек канала (должен быть ULAW или ALAW)

**Ожидаемая стоимость**: При 10,000 минут в месяц - около 6,400 ₽[8]

**Задержка**: После оптимизации - 1.0-1.5 секунды[7]

Этот план позволит вам полностью интегрировать Yandex SpeechKit с Asterisk для получения качественного потокового распознавания и синтеза русской речи с минимальными задержками.


ПРОДОЛЖЕНИЕ:

Вы абсолютно правы! Действительно, есть проверенные готовые решения от сообщества, которые избавят вас от необходимости изобретать велосипед. Вот **готовые** решения:

## 🎯 Готовые скрипты для Yandex SpeechKit + Asterisk

### 1. Проверенное решение с Habr (2023 год)

**Автор**: разработчик с ником на Habr, полностью рабочее решение[1]

**Что входит в пакет**:
- Готовый Python скрипт для EAGI интеграции
- Настроенная конфигурация Asterisk
- Инструкция по установке

**Скачать готовое решение**:
```bash
# Клонируйте Yandex CloudAPI
git clone https://github.com/yandex-cloud/cloudapi.git
cd cloudapi

# Генерируем proto файлы
python3 -m grpc_tools.protoc -I . -I third_party/googleapis \
  --python_out=. --grpc_python_out=. \
  yandex/cloud/ai/stt/v2/stt_service.proto
```

**Готовый скрипт** (проверенный сообществом):
```python
#!/usr/bin/python3.6
#coding=utf8
import argparse
from asterisk.agi import *
import requests
import grpc
import os
import yandex.cloud.ai.stt.v2.stt_service_pb2 as stt_service_pb2
import yandex.cloud.ai.stt.v2.stt_service_pb2_grpc as stt_service_pb2_grpc

agi = AGI()
CHUNK_SIZE = 4000

# ЗАМЕНИТЕ НА ВАШИ ДАННЫЕ:
folder = "ваш_folder_id"
token = "ваш_iam_token"

def gen(folder_id):
    # Настройки распознавания
    specification = stt_service_pb2.RecognitionSpec(
        language_code='ru-RU',
        profanity_filter=True,
        model='general',
        partial_results=True,
        audio_encoding='LINEAR16_PCM',
        sample_rate_hertz=8000
    )
    
    streaming_config = stt_service_pb2.RecognitionConfig(
        specification=specification, 
        folder_id=folder_id
    )
    
    # Отправляем конфигурацию
    yield stt_service_pb2.StreamingRecognitionRequest(config=streaming_config)
    
    # Читаем аудио через EAGI (file descriptor 3)
    with os.fdopen(3, 'rb') as f:
        data = f.read(CHUNK_SIZE)
        while data != b'':
            yield stt_service_pb2.StreamingRecognitionRequest(audio_content=data)
            data = f.read(CHUNK_SIZE)

def run(folder_id, iam_token):
    # gRPC соединение
    cred = grpc.ssl_channel_credentials()
    channel = grpc.secure_channel('stt.api.cloud.yandex.net:443', cred)
    stub = stt_service_pb2_grpc.SttServiceStub(channel)
    
    # Потоковое распознавание
    it = stub.StreamingRecognize(
        gen(folder_id), 
        metadata=(('authorization', 'Bearer %s' % iam_token),)
    )
    
    try:
        for r in it:
            try:
                for alternative in r.chunks[0].alternatives:
                    agi.verbose(alternative.text)
                    
                    if r.chunks[0].final:
                        agi.verbose("ФИНАЛЬНЫЙ РЕЗУЛЬТАТ")
                        
                        # Синтезируем ответ
                        with open("/tmp/response.raw", "wb") as f:
                            for audio_content in synthesize(alternative.text):
                                f.write(audio_content)
                        
                        # Воспроизводим
                        agi.stream_file("/tmp/response")
                        
            except LookupError:
                agi.verbose('Нет доступных чанков')
                
    except grpc._channel._Rendezvous as err:
        agi.verbose('gRPC Error: %s' % err._state.details)

def synthesize(text):
    url = 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize'
    headers = {'Authorization': 'Bearer ' + token}
    
    data = {
        'text': text,
        'lang': 'ru-RU',
        'folderId': folder,
        'sampleRateHertz': '8000',
        'format': 'lpcm'
    }
    
    with requests.post(url, headers=headers, data=data, stream=True) as resp:
        if resp.status_code != 200:
            raise RuntimeError("TTS Error: %s" % resp.text)
        
        for chunk in resp.iter_content(chunk_size=None):
            yield chunk

if __name__ == '__main__':
    run(folder, token)
```

### 2. Альтернативные готовые решения

#### Google Speech для Asterisk (адаптируемый под Yandex)

**Репозиторий**: https://github.com/zaf/asterisk-speech-recog[2]

**Особенности**:
- 132 форка, активное сообщество
- Perl-скрипт, легко модифицируется под Yandex API
- Поддерживает русский язык `ru-RU`

#### Vosk + Asterisk (локальное решение)

**Репозиторий**: https://github.com/alphacep/vosk-asterisk[3]

**Особенности**:
- Полностью локальное решение
- Модули для прямой интеграции с Asterisk
- 120 звезд, активная разработка

## 🚀 Экспресс-установка готового решения (10 минут)

### Шаг 1: Подготовка (2 минуты)
```bash
# Установка зависимостей
sudo apt install python3-pip
pip3 install pyst2 grpcio grpcio-tools requests

# Создание рабочей папки
sudo mkdir -p /var/lib/asterisk/agi-bin/yandex
cd /var/lib/asterisk/agi-bin/yandex
```

### Шаг 2: Загрузка готового кода (3 минуты)
```bash
# Клонируем CloudAPI
sudo git clone https://github.com/yandex-cloud/cloudapi.git

# Генерируем необходимые файлы
cd cloudapi
sudo python3 -m grpc_tools.protoc -I . -I third_party/googleapis \
    --python_out=. --grpc_python_out=. \
    yandex/cloud/ai/stt/v2/stt_service.proto

# Копируем готовый скрипт из Habr
sudo wget -O ../yandex_speech.py "ссылка_на_готовый_скрипт"
sudo chmod +x ../yandex_speech.py
```

### Шаг 3: Настройка Asterisk (3 минуты)
```bash
# Добавляем в /etc/asterisk/extensions.conf
echo "
[from-internal]
exten => 444,1,Answer()
exten => 444,n,EAGI(yandex/yandex_speech.py)
exten => 444,n,Hangup()
" | sudo tee -a /etc/asterisk/extensions.conf

# Перезагружаем Asterisk
sudo systemctl reload asterisk
```

### Шаг 4: Настройка токенов (2 минуты)
```bash
# Редактируем скрипт
sudo nano /var/lib/asterisk/agi-bin/yandex/yandex_speech.py

# Заменяем строки:
# folder = "ваш_folder_id_из_yandex_console"  
# token = "ваш_iam_token_из_yandex_console"
```


## ⚠️ Важные моменты готовых решений

**Из статьи на Habr**:[1]
> "Asterisk распространяемый в Ubuntu репозиториях не поддерживает EAGI потоки. Получилось только после сборки из исходников с включением EAGI потоков в menuconfig"

**Решение**: Используйте готовые сборки Asterisk с EAGI или пересоберите из исходников.

