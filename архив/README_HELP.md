# üö® –ü–†–û–ë–õ–ï–ú–´ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò AI –ì–û–õ–û–°–û–í–û–ì–û –ê–°–°–ò–°–¢–ï–ù–¢–ê

## üìä –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï –ü–†–û–ë–õ–ï–ú–´

**–ë–´–õ–û (Voximplant)**: 2-3 —Å–µ–∫—É–Ω–¥—ã –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ ‚úÖ  
**–°–¢–ê–õ–û (Asterisk)**: 11+ —Å–µ–∫—É–Ω–¥ –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ ‚ùå

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò

### ‚è±Ô∏è –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞:

```
06:19:50,118 - ‚è±Ô∏è –ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–Ω—è–ª–∞ 0.000—Å ‚úÖ
06:19:56,503 - ‚è±Ô∏è –ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï: –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–Ω—è–ª–∞ 6.385—Å ‚ùå
06:19:56,516 - ‚è±Ô∏è –ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï: –û–±—â–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–Ω—è–ª–∞ 6.418—Å ‚ùå
06:19:57,007 - ‚è±Ô∏è –ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï: –ü–µ—Ä–≤—ã–π —á–∞–Ω–∫ –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ 0.491—Å ‚úÖ
06:20:01,594 - ‚è±Ô∏è –ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï: –í–µ—Å—å streaming –∑–∞–Ω—è–ª 5.064—Å ‚ùå
06:20:01,595 - ‚è±Ô∏è –ü–†–û–§–ò–õ–ò–†–û–í–ê–ù–ò–ï STASIS: –û–±—Ä–∞–±–æ—Ç–∫–∞ AI response –∑–∞–Ω—è–ª–∞ 11.497—Å ‚ùå
```

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´

### **–§—É–Ω–∫—Ü–∏—è `_max_relevance()` –≤ agent.py**

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –í—ã–ø–æ–ª–Ω—è–µ—Ç `similarity_search_with_relevance_scores()` –¥–≤–∞–∂–¥—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 6.4+ —Å–µ–∫—É–Ω–¥—ã
**–ü—Ä–æ–±–ª–µ–º–∞**: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –û–¢–°–£–¢–°–¢–í–û–í–ê–õ–ê –≤ –±—ã—Å—Ç—Ä–æ–π Voximplant –≤–µ—Ä—Å–∏–∏!

```python
def _max_relevance(self, question: str, kb: str, k: int) -> float:
    # –≠–¢–ê –§–£–ù–ö–¶–ò–Ø –¢–†–ê–¢–ò–¢ 6.4 –°–ï–ö–£–ù–î–´!
    res = self.db.similarity_search_with_relevance_scores(
        question, k=k, filter={"kb": kb}
    )
```

## üìã –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –†–ê–ó–õ–ò–ß–ò–Ø

### **Voximplant (–ë–´–°–¢–†–ê–Ø) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
WebSocket ‚Üí Agent.get_response_generator() ‚Üí RAG chain ‚Üí –û—Ç–≤–µ—Ç
```

### **Asterisk (–ú–ï–î–õ–ï–ù–ù–ê–Ø) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
ARI WebSocket ‚Üí stasis_handler ‚Üí Agent.get_response_generator() ‚Üí 
_max_relevance() (6.4 —Å–µ–∫!) ‚Üí RAG chain ‚Üí –û—Ç–≤–µ—Ç
```

## üîß –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ **1. –£–¥–∞–ª–µ–Ω–∞ –º–µ–¥–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `_max_relevance()`**
```python
# –ë–´–õ–û:
max_score = self._max_relevance(user_question, target, k)  # 6.4 —Å–µ–∫!
alt_score = self._max_relevance(user_question, alt, k)    # +6.4 —Å–µ–∫!

# –°–¢–ê–õ–û:
target = self._route_kb(user_question)  # 0.001 —Å–µ–∫
# –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
```

### ‚úÖ **2. –£–ø—Ä–æ—â–µ–Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**
```python
# –í–µ—Ä–Ω—É–ª–∏—Å—å –∫ –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–µ –∫–∞–∫ –≤ Voximplant –≤–µ—Ä—Å–∏–∏
def _route_kb(self, text: str) -> str:
    # –ë—ã—Å—Ç—Ä–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    if any(marker in text.lower() for marker in tech_markers):
        return "tech"
    return "general"
```

### ‚úÖ **3. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –í `agent.py`: –≤—Ä–µ–º—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, streaming, —á–∞–Ω–∫–æ–≤
- –í `stasis_handler.py`: –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI response

## üöÄ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### **1. gRPC TTS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**
```
ERROR - ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ gRPC TTS: module 'yandex.cloud.ai.tts.v3.tts_service_pb2' has no attribute 'UtteranceSynthesisRequest'
```

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ proto —Ñ–∞–π–ª—ã  
**–°—Ç–∞—Ç—É—Å**: Fallback –Ω–∞ HTTP API —Ä–∞–±–æ—Ç–∞–µ—Ç (0.3-0.5 —Å–µ–∫)

### **2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ embedding –∑–∞–ø—Ä–æ—Å—ã**
```
05:30:12,740 - POST https://api.openai.com/v1/embeddings  
05:30:13,257 - POST https://api.openai.com/v1/embeddings
05:30:14,087 - POST https://api.openai.com/v1/embeddings
```

**–ü—Ä–∏—á–∏–Ω–∞**: LangChain –¥–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ embedding –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è RAG  
**–†–µ—à–µ–Ω–∏–µ**: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### **3. –î–≤–æ–π–Ω—ã–µ LLM –∑–∞–ø—Ä–æ—Å—ã**
```
05:30:15,298 - POST /chat/completions (–ø–µ—Ä–≤—ã–π)
05:30:52,919 - POST /chat/completions (–≤—Ç–æ—Ä–æ–π!)
```

**–ü—Ä–∏—á–∏–Ω–∞**: –í–æ–∑–º–æ–∂–Ω–æ, retry –ª–æ–≥–∏–∫–∞ –∏–ª–∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|-----------|----------------|-------------------|
| **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** | 0.001—Å ‚úÖ | 0.001—Å ‚úÖ |
| **–û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏** | 6.385—Å ‚ùå | –£–î–ê–õ–ï–ù–ê ‚úÖ |
| **–û–±—â–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞** | 6.418—Å ‚ùå | ~0.001—Å ‚úÖ |
| **AI streaming** | 5.064—Å | 2-3—Å (–æ–∂–∏–¥–∞–µ—Ç—Å—è) |
| **–û–ë–©–ï–ï –í–†–ï–ú–Ø** | 11.5—Å ‚ùå | 2-3—Å ‚úÖ |

## üéØ –§–ê–ô–õ–´ –£–ß–ê–°–¢–í–£–Æ–©–ò–ï –í –¶–ï–ü–û–ß–ö–ï

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
1. `app/backend/asterisk/stasis_handler.py` - –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
2. `app/backend/rag/agent.py` - AI –∞–≥–µ–Ω—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
3. `app/backend/asterisk/ari_client.py` - ARI –∫–ª–∏–µ–Ω—Ç
4. `app/backend/services/yandex_tts_service.py` - TTS —Å–µ—Ä–≤–∏—Å
5. `app/backend/services/asr_service.py` - ASR —Å–µ—Ä–≤–∏—Å
6. `app/backend/utils/text_normalizer.py` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
7. `app/backend/services/log_storage.py` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
8. `.env` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Asterisk:**
- `/etc/asterisk/extensions.conf` - –¥–∏–∞–ª–ø–ª–∞–Ω
- `/etc/asterisk/pjsip.conf` - SIP
- `/etc/asterisk/ari.conf` - ARI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üîÑ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –í–´–ü–û–õ–ù–ï–ù–ò–Ø

1. **–ó–≤–æ–Ω–æ–∫** ‚Üí Asterisk dialplan ‚Üí `Stasis(asterisk-bot)`
2. **stasis_handler.py** –ø–æ–ª—É—á–∞–µ—Ç ARI WebSocket —Å–æ–±—ã—Ç–∏–µ
3. **ari_client.py**: Answer() ‚Üí StartRecording()
4. **asr_service.py**: OpenAI Whisper —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (~2 —Å–µ–∫)
5. **agent.py**: 
   - ~~_max_relevance() (–£–î–ê–õ–ï–ù–û - –±—ã–ª–æ 6.4 —Å–µ–∫)~~
   - _route_kb() (0.001 —Å–µ–∫)
   - RAG chain —Å ChromaDB (2-3 —Å–µ–∫)
6. **yandex_tts_service.py**: HTTP TTS (0.3-0.5 —Å–µ–∫)
7. **ari_client.py**: Playback() ‚Üí StartRecording()
8. **log_storage.py**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SQLite

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–û–ú–ï–ù–¢–´

### **1. ChromaDB –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º deprecation
- –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π –ø—Ä–∏ –±–æ–ª—å—à–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ `langchain-chroma`

### **2. OpenAI API –ª–∏–º–∏—Ç—ã**
- Streaming –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
- –ï—Å—Ç—å fallback –Ω–∞ non-streaming —Ä–µ–∂–∏–º

### **3. –ü–∞–º—è—Ç—å –∏ —Ä–µ—Å—É—Ä—Å—ã**
- ChromaDB –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (~9 —Å–µ–∫—É–Ω–¥)
- Embeddings —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –î–ê–õ–¨–ù–ï–ô–®–ï–ô –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –¥–Ω—è):**
1. ‚úÖ –£–¥–∞–ª–∏—Ç—å `_max_relevance()` (–°–î–ï–õ–ê–ù–û)
2. üîÑ –ò—Å–ø—Ä–∞–≤–∏—Ç—å gRPC TTS –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 1-1.5 —Å–µ–∫
3. üîÑ –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

### **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1 –Ω–µ–¥–µ–ª—è):**
1. –û–±–Ω–æ–≤–∏—Ç—å ChromaDB –¥–æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä embeddings
3. –î–æ–±–∞–≤–∏—Ç—å Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

### **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (1 –º–µ—Å—è—Ü):**
1. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ async/await –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. –î–æ–±–∞–≤–∏—Ç—å load balancing
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∏ RAG pipeline

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**: —Ñ—É–Ω–∫—Ü–∏—è `_max_relevance()` —Ç—Ä–∞—Ç–∏–ª–∞ 6.4+ —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –Ω–µ–Ω—É–∂–Ω—ã–µ similarity search –∑–∞–ø—Ä–æ—Å—ã.

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Ä–æ–≤–Ω—è Voximplant –≤–µ—Ä—Å–∏–∏: **2-3 —Å–µ–∫—É–Ω–¥—ã –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞**.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 04.09.2025*  
*–°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞*  
*–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏*
