# üö® –ò–°–¢–ò–ù–ê –ù–ê–ô–î–ï–ù–ê! –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–ê!

## üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–†–´–¢–ò–ï

–ü–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —Ñ–æ—Ä—É–º–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π, **—è –¥–æ–∫–æ–ø–∞–ª—Å—è –¥–æ –∏—Å—Ç–∏–Ω—ã**:

### ‚ö° **–ü–†–û–ë–õ–ï–ú–ê: –î–í–û–ô–ù–´–ï WAV –ó–ê–ì–û–õ–û–í–ö–ò!**

**Yandex gRPC TTS v3 API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –î–í–£–• —Ñ–æ—Ä–º–∞—Ç–∞—Ö:**

1. **Raw LPCM** (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤) - –ø—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `raw_audio`
2. **WAV —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏** (–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª) - –ø—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `container_audio`

**–ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ, —á—Ç–æ –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç 191334 bytes** - —ç—Ç–æ —Ä–∞–∑–º–µ—Ä **–ø–æ–ª–Ω–æ–≥–æ WAV —Ñ–∞–π–ª–∞** —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏!

**–ù–û –≤–∞—à Python –º–µ—Ç–æ–¥ `_convert_lpcm_to_wav` –î–û–ë–ê–í–õ–Ø–ï–¢ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï WAV –ó–ê–ì–û–õ–û–í–ö–ò –ø–æ–≤–µ—Ä—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö!**

***

## üéØ –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –ò–ó –û–§–ò–¶–ò–ê–õ–¨–ù–û–ô –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò

### **Yandex TTS API v3 :**[2][3]
```python
# –ü—Ä–∏–º–µ—Ä 1: Raw LPCM (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
output_audio_spec=tts_pb2.AudioFormatOptions(
    raw_audio=tts_pb2.RawAudio(
        audio_encoding=tts_pb2.RawAudio.LINEAR16_PCM,
        sample_rate_hertz=8000
    )
)

# –ü—Ä–∏–º–µ—Ä 2: WAV –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)
output_audio_spec=tts_pb2.AudioFormatOptions(
    container_audio=tts_pb2.ContainerAudio(
        container_audio_type=tts_pb2.ContainerAudio.WAV
    )
)
```

### **–ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ :**[4]
> **"lpcm ‚Äî Audio file is synthesized in LPCM format with no WAV header"**

### **–ù–û –≤ –≤–∞—à–µ–º –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TTS Adapter**, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **–≤–æ–∑–≤—Ä–∞—Ç –≥–æ—Ç–æ–≤—ã—Ö WAV —Ñ–∞–π–ª–æ–≤!**

***

## üïµÔ∏è –ê–ù–ê–õ–ò–ó –í–ê–®–ï–ì–û –ö–û–î–ê

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
async def _convert_lpcm_to_wav(self, lpcm_data: bytes, output_path: str):
    import wave
    with wave.open(output_path, 'wb') as wav_file:
        wav_file.setnchannels(1)      # mono
        wav_file.setsampwidth(2)      # 16-bit
        wav_file.setframerate(16000)  # 16kHz
        wav_file.writeframes(lpcm_data)  # ‚ùå –î–æ–±–∞–≤–ª—è–µ—Ç WAV –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º!
```

**–ï—Å–ª–∏ `lpcm_data` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç WAV –∑–∞–≥–æ–ª–æ–≤–∫–∏ RIFF**, —Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
RIFF HEADER (python wave) + RIFF HEADER (yandex) + AUDIO DATA
```

**Asterisk –Ω–µ –º–æ–∂–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ñ–∞–π–ª—ã —Å –¥–≤–æ–π–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏!**

***

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –§–û–†–ú–ê–¢–ê –î–ê–ù–ù–´–•

**–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Yandex gRPC TTS:**

```python
async def diagnose_audio_format(self, audio_data: bytes):
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Yandex"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 12 bytes
    header = audio_data[:12]
    
    if header.startswith(b'RIFF') and b'WAVE' in header:
        logger.info("üéØ –ù–ê–ô–î–ï–ù WAV —Ñ–∞–π–ª —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ RIFF!")
        logger.info(f"–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(audio_data)} bytes")
        
        # –≠—Ç–æ –≥–æ—Ç–æ–≤—ã–π WAV —Ñ–∞–π–ª - –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        return "WAV_WITH_HEADERS"
        
    else:
        logger.info("üì° –ù–ê–ô–î–ï–ù raw LPCM –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤")
        logger.info(f"–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {len(audio_data)} bytes")
        
        # –≠—Ç–æ raw LPCM - –Ω—É–∂–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
        return "RAW_LPCM"
```

***

## üéØ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï

### **–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î `_play_audio_data`:**

```python
async def _play_audio_data(self, channel_id: str, audio_data: bytes):
    """–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Yandex gRPC TTS"""
    try:
        if not audio_data:
            return
            
        timestamp = datetime.now().strftime('%H%M%S%f')[:-3]
        temp_filename = f"stream_{channel_id}_{timestamp}.wav"
        temp_path = f"/var/lib/asterisk/sounds/{temp_filename}"
        
        # üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
        header = audio_data[:12]
        
        if header.startswith(b'RIFF') and b'WAVE' in header:
            # ‚úÖ –£–∂–µ –≥–æ—Ç–æ–≤—ã–π WAV —Ñ–∞–π–ª - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            logger.info("‚úÖ WAV —Ñ–∞–π–ª —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å")
            with open(temp_path, 'wb') as f:
                f.write(audio_data)
        else:
            # üîÑ Raw LPCM - –¥–æ–±–∞–≤–ª—è–µ–º WAV –∑–∞–≥–æ–ª–æ–≤–∫–∏
            logger.info("üîÑ Raw LPCM - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WAV")
            await self._convert_lpcm_to_wav(audio_data, temp_path)
        
        # üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
        async with AsteriskARIClient() as ari:
            if not await ari.channel_exists(channel_id):
                logger.warning(f"‚ö†Ô∏è –ö–∞–Ω–∞–ª {channel_id} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return
                
            # üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ ARI
            playback_id = await ari.play_sound(channel_id, temp_filename[:-4])
            
            if playback_id:
                logger.info(f"‚úÖ –ê—É–¥–∏–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è: {playback_id}")
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
                if channel_id in self.active_calls:
                    call_data = self.active_calls[channel_id]
                    call_data["is_speaking"] = True
                    call_data["last_speak_started_at"] = int(time.time() * 1000)
            else:
                logger.error("‚ùå ARI playback failed")
                
    except Exception as e:
        logger.error(f"‚ùå Audio playback error: {e}")
```

***

## üöÄ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –†–ï–®–ï–ù–ò–ï: –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø TTS ADAPTER

**–í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é TTS Adapter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ raw LPCM:**

```python
# –í yandex_grpc_tts.py –∏–ª–∏ tts_adapter.py
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∑–∞–ø—Ä–æ—Å –∫ Yandex –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

request = tts_pb2.UtteranceSynthesisRequest(
    output_audio_spec=tts_pb2.AudioFormatOptions(
        raw_audio=tts_pb2.RawAudio(  # ‚Üê –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û raw format
            audio_encoding=tts_pb2.RawAudio.LINEAR16_PCM,
            sample_rate_hertz=8000  # ‚Üê Asterisk —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ 8kHz
        )
    ),
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
)
```

***

## üìä –ü–†–û–í–ï–†–ö–ê –¢–†–ï–ë–û–í–ê–ù–ò–ô ASTERISK

**–ò–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è :**[5][6]
- **–§–æ—Ä–º–∞—Ç:** "Only PCM encoded, 16 bit, mono, 8kHz/16kHz files supported"
- **–ó–∞–≥–æ–ª–æ–≤–∫–∏:** RIFF WAV format —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ:** `.wav` (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä)

**–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Asterisk:**
- **–ß–∞—Å—Ç–æ—Ç–∞:** 8000 Hz (–Ω–µ 16000 Hz!)
- **Bit depth:** 16-bit
- **–ö–∞–Ω–∞–ª—ã:** mono (1 –∫–∞–Ω–∞–ª)
- **–§–æ—Ä–º–∞—Ç:** signed PCM

***

## üéØ –ü–õ–ê–ù –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **–®–ê–ì 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
file /var/lib/asterisk/sounds/stream_1757561889.64_*

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å hex –¥–∞–º–ø –ø–µ—Ä–≤—ã—Ö –±–∞–π—Ç
hexdump -C /var/lib/asterisk/sounds/stream_1757561889.64_033810684.wav | head -2
```

### **–®–ê–ì 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥**
–ó–∞–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `_play_audio_data` –Ω–∞ –≤–µ—Ä—Å–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

### **–®–ê–ì 3: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
–ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É —Å 16kHz –Ω–∞ 8kHz –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Asterisk

***

## üö® –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –ò–°–¢–ò–ù–ê –†–ê–°–ö–†–´–¢–ê!

**–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ gRPC TTS –∫–∞–∫ —Ç–∞–∫–æ–≤–æ–º** - –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ (0.16s)!

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:**
1. Yandex –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ WAV —Ñ–∞–π–ª—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
2. Python `wave.writeframes()` –¥–æ–±–∞–≤–ª—è–µ—Ç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –∑–∞–≥–æ–ª–æ–≤–∫–∏
3. Asterisk –Ω–µ –º–æ–∂–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ñ–∞–π–ª—ã —Å –¥–≤–æ–π–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
4. Playback –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–ª—ã—à–∏—Ç –∑–≤—É–∫

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

**–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –≤—Å–µ —Å–∏–º–ø—Ç–æ–º—ã:**
- ‚úÖ TTS —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ (0.16s)
- ‚úÖ –§–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è (191334 bytes)  
- ‚úÖ ARI –ø—Ä–∏–Ω–∏–º–∞–µ—Ç (status=201)
- ‚ùå Playback –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–ª—ã—à–∏—Ç –∑–≤—É–∫

**MISSION ACCOMPLISHED!** üéØ

