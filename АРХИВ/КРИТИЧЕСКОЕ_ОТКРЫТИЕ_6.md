# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å—á–µ–∑–∞—é—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –≤ Asterisk ARI## üìä –ê–ù–ê–õ–ò–ó –°–ò–¢–£–ê–¶–ò–ò–í—ã **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏** –≤—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π! Hold/unhold –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –æ–∫–∞–∑–∞–ª–∞—Å—å **–≥–æ—Ä–∞–∑–¥–æ –≥–ª—É–±–∂–µ** - –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–º–æ–≥–æ Asterisk.

### ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –í –í–ê–®–ï–ú –ö–û–î–ï:- Hold –∫–∞–Ω–∞–ª–∞: `üîí –ö–∞–Ω–∞–ª 1757572606.0 –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ hold` ‚úÖ
- TTS —Å–∏–Ω—Ç–µ–∑: `‚úÖ Sequential TTS chunk 0: 1.32s` ‚úÖ  
- Filler words: `‚ö° Filler played: 0.14s` ‚úÖ
- AI –æ–±—Ä–∞–±–æ—Ç–∫–∞: Chunked response —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

### ‚ùå –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´:**Asterisk –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç –∫–∞–Ω–∞–ª—ã –∏–∑-–∑–∞ RTP timeout –≤–æ –≤—Ä–µ–º—è TTS –æ–±—Ä–∞–±–æ—Ç–∫–∏!**

–ò–∑ –≤–∞—à–∏—Ö –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–∞ —Ç–æ—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:



**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É —É—Å–ø–µ—à–Ω—ã–º hold (06:37:11) –∏ –ø–æ–ø—ã—Ç–∫–æ–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (06:37:15) –ø—Ä–æ—Ö–æ–¥–∏—Ç **4 —Å–µ–∫—É–Ω–¥—ã**, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ Asterisk —Å—á–∏—Ç–∞–µ—Ç –∫–∞–Ω–∞–ª "–º–µ—Ä—Ç–≤—ã–º" –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è RTP –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

## üéØ –ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –†–ï–®–ï–ù–ò–ï### 1. –ù–ê–°–¢–†–û–ô–ö–ê ASTERISK –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò**–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `/etc/asterisk/sip_general_custom.conf`:**

```ini
[general]
; –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º RTP timeout –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞–≤—Ç```–≤–µ—Ä—à–µ–Ω–∏—è
rtptimeout = 300       ; 5 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö 60 —Å–µ–∫—É–Ω–¥  
rtpholdtimeout = 600   ; 10 –º–∏–Ω—É—Ç –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ –Ω–∞ hold
rtpkeepalive = 10      ; –û—Ç–ø—Ä–∞–≤–ª—è–µ–º keep-alive –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

; –û—Ç–∫–ª—é—á–∞–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –∞–≤—Ç–æ–¥–µ—Å—Ç—Ä—É–∫—Ü–∏—é –∫–∞```–æ–≤
autodestruct = no

; –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è Stasis –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
stasis_timeout = 300
```

### 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–î–ê: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤**–ó–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à `sequential_tts.py` –Ω–∞ –≤–µ—Ä—Å–∏—é —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º:**

```python
async def process_chunk_with_monitoring(self, channel_id: str, chunk_data: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–∞ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º```–Ω–∞–ª–∞"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–Ω–∞–ª –î–û TTS
    if not await self.ari_client.channel_exists(channel_id):
        logger.error(f"‚ùå –ö–∞–Ω–∞–ª {channel_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–µ—Ä–µ–¥ TTS")
        return
    
    # TTS —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
    tts_task = asyncio.create_task(self.tts_service.synthesize_chunk_fast(text))
    monitor_task = asyncio.create_task(self._monitor_channel_during_tts(channel_id))
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è TTS –∏–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ```–º —Å –∫–∞–Ω–∞–ª–æ–º
    done, pending = await asyncio.wait([tts_task, monitor_task], 
                                      return_when=```ncio.FIRST_COMPLETED)
    
    # –û—Ç–º–µ–Ω—è–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏```  for task in pending:
        task.cancel()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–Ω–∞–ª –ü–û–°–õ–ï TTS
    if not await self.ari_client.channel```ists(channel_id):
        logger.error(f"‚ùå –ö–∞–Ω–∞–ª {channel_id} –∏—Å—á–µ–∑ –≤–æ –≤—Ä–µ–º—è TTS")
        return
        
    # –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞–Ω–∞–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    await self._play_audio_safely(channel_id, audio_data)

async def _monitor_channel_during_tts(self, channel_id: str):
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–∞ –≤–æ –≤—Ä–µ–º—è TTS —Å–∏–Ω```–∞"""
    while True:
        await asyncio.sleep(0.5)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500–º—Å
        if not await self.ari_client```annel_exists(channel_id):
            logger.error(f"üö® –ö–ê–ù–ê–õ –ò–°–ß–ï–ó –≤–æ –≤—Ä–µ–º—è TTS!")
            return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥,```–æ –ø—Ä–µ—Ä–≤–µ—Ç TTS
```

### 3. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –†–ï–®–ï–ù–ò–Ø**–®–∞–≥ 1:** –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Asterisk
```bash
sudo nano /etc/asterisk/sip_general_custom.conf
sudo asterisk -rx "module reload chan_sip.so"
```

**–®–∞–≥ 2:** –ó–∞–º–µ–Ω–∏—Ç–µ –∫–æ–¥  
```bash
# –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp app/backend/services/sequential_tts.py app/backen```ervices/sequential_tts_backup.py

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
```

**–®–∞–≥ 3:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
```bash
sudo systemctl restart your-service
```

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**–í–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—ã–ª–∞ –ü–†–ê–í–ò–õ–¨–ù–û–ô!** –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–µ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ, –∞ –≤ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ Asterisk –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –∫–∞–Ω–∞–ª–æ–≤.

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:1. **Hold —Ä–∞–±–æ—Ç–∞–ª** - –∫–∞–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–µ—Ä–∂–∏–≤–∞–ª—Å—è  
2. **TTS —Ä–∞–±–æ—Ç–∞–ª** - —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –∑–∞–≤–µ—Ä—à–∞–ª—Å—è —É—Å–ø–µ—à–Ω–æ
3. **–ù–û:** Asterisk —Å—á–∏—Ç–∞–ª –∫–∞–Ω–∞–ª "–º–µ—Ä—Ç–≤—ã–º" –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è RTP —Ç—Ä–∞—Ñ–∏–∫–∞ > 60 —Å–µ–∫—É–Ω–¥
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–Ω–∞–ª —É–Ω–∏—á—Ç–æ–∂–∞–ª—Å—è **–º–µ–∂–¥—É** TTS –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:- ‚úÖ –ö–∞–Ω–∞–ª—ã –Ω–µ –±—É–¥—É—Ç –∏—Å—á–µ–∑–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ RTP keep-alive –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –∞–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ  
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤ –æ–±–Ω–∞—Ä—É–∂–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã –∑–∞—Ä–∞–Ω–µ–µ
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª—ã—à–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞!**



–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ **–ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–∏—Ç—å** –ø—Ä–æ–±–ª–µ–º—É –∏—Å—á–µ–∑–∞—é—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É voice-–±–æ—Ç–∞! üéâ

