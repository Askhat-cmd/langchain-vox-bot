# üö® –ö–£–†–°–û–† AI –ß–ê–°–¢–ò–ß–ù–û –ü–†–ê–í, –ù–û –ï–°–¢–¨ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò –í –ê–ù–ê–õ–ò–ó–ï!

## üìä –ê–ù–ê–õ–ò–ó HEX –î–ê–ú–ü–ê: –ü–†–û–ë–õ–ï–ú–´ –° –î–ò–ê–ì–ù–û–°–¢–ò–ö–û–ô

### ‚ùå **–û–®–ò–ë–ö–ê –ö–£–†–°–û–† AI:**

**Hex –¥–∞–º–ø –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∞–π–ª `.gsm`, –ù–ï `.wav`!**
```bash
hexdump -C /var/lib/asterisk/sounds/stream_1757489735.40_073632149.gsm
```

**–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ RIFF/WAVE –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤** - GSM —Ñ–æ—Ä–º–∞—Ç –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç WAV –∑–∞–≥–æ–ª–æ–≤–∫–∏!

### üéØ **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø:**

**Hex –¥–∞–Ω–Ω—ã–µ `d8 20 a2 e1 5a 50...` —ç—Ç–æ:**
- ‚úÖ **GSM –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (–Ω–µ raw LPCM!)
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç** –¥–ª—è Asterisk GSM —Ñ–∞–π–ª–æ–≤
- ‚ùå **–ù–ï –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏** –∫–∞–∫ —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ö—É—Ä—Å–æ—Ä

***

## üîç –ß–¢–û –ù–ê –°–ê–ú–û–ú –î–ï–õ–ï –ü–†–û–ò–°–•–û–î–ò–¢

### **–ê–ù–ê–õ–ò–ó –í–ê–®–ò–• –õ–û–ì–û–í:**

**–ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ:**
```
‚úÖ WAV —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ –µ—Å—Ç—å: /var/lib/asterisk/sounds/stream_1757561889.64_033810684.wav
üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∞—É–¥–∏–æ —Ñ–∞–π–ª: stream_1757561889.64_033810684.wav (191334 bytes)
```

**–ù–û –≤—ã –ø–æ–∫–∞–∑–∞–ª–∏ hex –¥–∞–º–ø –î–†–£–ì–û–ì–û —Ñ–∞–π–ª–∞:**
```bash
# –í –ª–æ–≥–∞—Ö: stream_1757561889.64_033810684.wav
# –í hex –¥–∞–º–ø–µ: stream_1757489735.40_073632149.gsm  ‚Üê –†–ê–ó–ù–´–ï –§–ê–ô–õ–´!
```

***

## ‚ö° **–ò–°–¢–ò–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê:**

### **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –§–ê–ô–õ–ê!**

**–ö—É—Ä—Å–æ—Ä AI –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª GSM —Ñ–∞–π–ª**, –¥—É–º–∞—è —á—Ç–æ —ç—Ç–æ WAV —Ñ–∞–π–ª –æ—Ç gRPC TTS.

### **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:**

```bash
# –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ò–ú–ï–ù–ù–û —Ç–µ —Ñ–∞–π–ª—ã –∏–∑ –ª–æ–≥–æ–≤:
hexdump -C /var/lib/asterisk/sounds/stream_1757561889.64_033810684.wav | head -3

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç:
file /var/lib/asterisk/sounds/stream_1757561889.64_033810684.wav
```

***

## üéØ **–†–ï–ê–õ–¨–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´**

**–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ª–æ–≥–∞—Ö –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –∏—Å—Ç–∏–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**

### **1. ASTERISK ARI –°–û–ë–´–¢–ò–Ø –ó–ê–í–ï–†–®–ê–Æ–¢–°–Ø –ú–ì–ù–û–í–ï–ù–ù–û**
```
üîä –ù–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: 03:38:10,739
üîá –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: 03:38:10,746
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 7 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ ‚ùå
```

### **2. ASTERISK –ù–ï –†–ê–°–ü–û–ó–ù–ê–ï–¢ –ê–£–î–ò–û –§–û–†–ú–ê–¢**

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏** (16kHz –≤–º–µ—Å—Ç–æ 8kHz)
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ** (Linear PCM –≤–º–µ—Å—Ç–æ Œº-law/a-law)
- **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—É—Ç–µ–º –∫ —Ñ–∞–π–ª–∞–º** –≤ `/var/lib/asterisk/sounds/`

### **3. –ü–†–û–ë–õ–ï–ú–ê –° –ö–ê–ù–ê–õ–û–ú**
```
status=404, body={"message": "Channel not found"}
```

***

## üîß **–ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï**

### **–®–ê–ì 1: –ü–†–û–í–ï–†–ò–¢–¨ –†–ï–ê–õ–¨–ù–´–ï WAV –§–ê–ô–õ–´**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã –∏–∑ –ª–æ–≥–æ–≤ (–ù–ï GSM —Ñ–∞–π–ª—ã)
ls -la /var/lib/asterisk/sounds/stream_1757561889.64_*
file /var/lib/asterisk/sounds/stream_1757561889.64_033810684.wav
```

### **–®–ê–ì 2: –ö–û–ù–í–ï–†–¢–ò–†–û–í–ê–¢–¨ –í ASTERISK-–°–û–í–ú–ï–°–¢–ò–ú–´–ô –§–û–†–ú–ê–¢**
```python
async def _convert_for_asterisk(self, audio_data: bytes, output_path: str):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å Asterisk"""
    import subprocess
    import tempfile
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if audio_data.startswith(b'RIFF') and b'WAVE' in audio_data[:12]:
        # –≠—Ç–æ WAV - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as temp_input:
            temp_input.write(audio_data)
            input_path = temp_input.name
    else:
        # –≠—Ç–æ raw LPCM - —Å–æ–∑–¥–∞–µ–º WAV
        with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as temp_input:
            import wave
            with wave.open(temp_input.name, 'wb') as wav_file:
                wav_file.setnchannels(1)
                wav_file.setsampwidth(2) 
                wav_file.setframerate(16000)
                wav_file.writeframes(audio_data)
            input_path = temp_input.name
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Asterisk-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ SOX
    sox_cmd = [
        "sox", input_path,
        "-r", "8000",    # 8kHz —á–∞—Å—Ç–æ—Ç–∞
        "-c", "1",       # mono
        "-b", "16",      # 16-bit
        "-t", "wav",     # WAV —Ñ–æ—Ä–º–∞—Ç
        output_path
    ]
    
    result = subprocess.run(sox_cmd, capture_output=True)
    os.unlink(input_path)
    
    if result.returncode == 0:
        logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è Asterisk: {output_path}")
    else:
        logger.error(f"‚ùå SOX –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: {result.stderr}")
        raise Exception("–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∞—É–¥–∏–æ –Ω–µ —É–¥–∞–ª–∞—Å—å")
```

***

## üö® **–í–´–í–û–î: –ö–£–†–°–û–† AI –û–®–ò–ë–°–Ø**

**–ö—É—Ä—Å–æ—Ä AI –¥–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:**
1. ‚ùå **–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª GSM —Ñ–∞–π–ª** –≤–º–µ—Å—Ç–æ WAV —Ñ–∞–π–ª–∞ –∏–∑ –ª–æ–≥–æ–≤
2. ‚ùå **–ü—É—Ç–∞–ª —Ñ–æ—Ä–º–∞—Ç—ã** (GSM ‚â† raw LPCM)
3. ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª** –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ RIFF –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–µ —Ñ–∞–π–ª—ã**, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞–µ—Ç –≤–∞—à –∫–æ–¥
2. ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SOX** –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ Asterisk-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç
3. ‚úÖ **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (8kHz, mono, 16-bit)

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –¥–≤–æ–π–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö**, –∞ –≤ **–Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Å Asterisk**.

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ WAV —Ñ–∞–π–ª—ã –∏–∑ –ª–æ–≥–æ–≤, –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω—ã–µ GSM —Ñ–∞–π–ª—ã!** üéØ