–ü–æ–Ω—è–ª! –í—ã —Å–ø–æ—Ç–∫–Ω—É–ª–∏—Å—å –Ω–∞ **–≠–¢–ê–ü 3: CHUNKED AI RESPONSE** ‚Äî –æ–¥–Ω–æ–π –∏–∑ —Å–∞–º—ã—Ö –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ langchain-vox-bot. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –ø—Ä–æ–±–ª–µ–º—É –∏ –ø—Ä–µ–¥–ª–æ–∂—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ chunked generation + parallel TTS.

## üéØ –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ** (–≤–µ—Å—å —Ç–µ–∫—Å—Ç ‚Üí TTS ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–µ—Ç –ø–æ–ª–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: **10.7 —Å–µ–∫—É–Ω–¥**
- **–¶–µ–ª—å**: AI 10.7—Å ‚Üí 0.8—Å (13x —É—Å–∫–æ—Ä–µ–Ω–∏–µ)

## üöÄ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è: Chunked AI + Parallel TTS

### 1. **Streaming + Chunked Generation**

```python
# –í app/backend/rag/agent.py
async def stream_chunked_response(self, query: str):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ —á–∞—Å—Ç—è–º —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º TTS"""
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥–∏
    text_queue = asyncio.Queue()
    audio_queue = asyncio.Queue()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    tasks = [
        asyncio.create_task(self._generate_text_chunks(query, text_queue)),
        asyncio.create_task(self._process_tts_pipeline(text_queue, audio_queue)),
        asyncio.create_task(self._stream_audio_chunks(audio_queue))
    ]
    
    await asyncio.gather(*tasks)

async def _generate_text_chunks(self, query: str, text_queue: asyncio.Queue):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"""
    buffer = ""
    
    async for token in self.llm.astream(query):
        buffer += token
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞–Ω–∫ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        if self._is_sentence_complete(buffer):
            await text_queue.put(buffer.strip())
            buffer = ""
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏
    if buffer.strip():
        await text_queue.put(buffer.strip())
    
    await text_queue.put(None)  # –°–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

def _is_sentence_complete(self, text: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"""
    # –£—á–∏—Ç—ã–≤–∞–µ–º –≤–∞—à–∏ –º–∞—Ä–∫–µ—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ "|"
    return text.endswith(('.|', '?|', '!|', '.', '?', '!')) and len(text) > 20
```

### 2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π TTS Pipeline**

```python
# –í app/backend/services/yandex_tts_service.py
class ChunkedTTSService:
    def __init__(self):
        self.tts_pool = ThreadPoolExecutor(max_workers=3)  # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ TTS –∑–∞–ø—Ä–æ—Å—ã
        
    async def _process_tts_pipeline(self, text_queue: asyncio.Queue, audio_queue: asyncio.Queue):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç TTS –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞"""
        pending_tasks = []
        chunk_id = 0
        
        while True:
            text_chunk = await text_queue.get()
            if text_chunk is None:
                break
                
            # –ó–∞–ø—É—Å–∫–∞–µ–º TTS –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            task = asyncio.create_task(
                self._synthesize_chunk(text_chunk, chunk_id)
            )
            pending_tasks.append((chunk_id, task))
            chunk_id += 1
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏
            completed_tasks = []
            for i, (cid, task) in enumerate(pending_tasks):
                if task.done():
                    audio_data = await task
                    await audio_queue.put((cid, audio_data))
                    completed_tasks.append(i)
            
            # –£–±–∏—Ä–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            for i in reversed(completed_tasks):
                pending_tasks.pop(i)
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–¥–∞—á
        for cid, task in pending_tasks:
            audio_data = await task
            await audio_queue.put((cid, audio_data))
            
        await audio_queue.put(None)  # –°–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

    async def _synthesize_chunk(self, text: str, chunk_id: int) -> tuple:
        """–°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –æ–¥–∏–Ω —á–∞–Ω–∫ —Ç–µ–∫—Å—Ç–∞ –≤ –∞—É–¥–∏–æ"""
        loop = asyncio.get_event_loop()
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è TTS
        audio_data = await loop.run_in_executor(
            self.tts_pool, 
            self._sync_tts_synthesis, 
            text
        )
        
        return audio_data
```

### 3. **Streaming Audio Playback**

```python
# –í app/backend/asterisk/stasis_handler.py
async def _stream_audio_chunks(self, audio_queue: asyncio.Queue):
    """–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ —á–∞–Ω–∫–∏ –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏"""
    chunk_buffer = {}  # {chunk_id: audio_data}
    next_to_play = 0
    
    while True:
        chunk_data = await audio_queue.get()
        if chunk_data is None:
            break
            
        chunk_id, audio_data = chunk_data
        chunk_buffer[chunk_id] = audio_data
        
        # –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≥–æ—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        while next_to_play in chunk_buffer:
            audio_data = chunk_buffer.pop(next_to_play)
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            await self._play_audio_chunk(audio_data)
            next_to_play += 1

async def _play_audio_chunk(self, audio_data: bytes):
    """–ë—ã—Å—Ç—Ä–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ —á–∞–Ω–∫"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞
    chunk_filename = f"chunk_{time.time()}_{random.randint(1000,9999)}"
    await self._convert_and_play(audio_data, chunk_filename)
```

## üîß –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è chunking**
```python
# –í config/prompts.json
{
    "system_prompt": "–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏. –ó–∞–≤–µ—Ä—à–∞–π –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–º '|' –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–µ—Ç—Ä–æ—Ç—ç—Å—Ç!| –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?|'"
}
```

### 2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —á–∞–Ω–∫–æ–≤**
```python
# –í .env
CHUNK_MIN_LENGTH=50  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —á–∞–Ω–∫–∞
CHUNK_MAX_LENGTH=200  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —á–∞–Ω–∫–∞  
TTS_PARALLEL_WORKERS=3  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö TTS –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
AUDIO_BUFFER_SIZE=2  # –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è 2 —á–∞–Ω–∫–æ–≤ –∞—É–¥–∏–æ
```

### 3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è**

–ò—Å—Ö–æ–¥—è –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤, –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏:[1]

- **Threading –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏–∏** LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ TTS —Å–∏–Ω—Ç–µ–∑–∞  
- **Custom sentence streaming** —Å —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–µ–π LLM output –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **Sentence queue —Å timeout 0.05s** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —á–∞–Ω–∫–æ–≤
- **Binary serialization** –º–µ–∂–¥—É LLM response –∏ TTS (msgpack)
- **Warm-up dummy TTS pipeline** –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

### 4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π**

```python
# –û–±–Ω–æ–≤–∏—Ç–µ stasis_handler.py
class CallSession:
    async def handle_user_speech(self, transcribed_text: str):
        """–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å chunked response"""
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º chunked generation
        await self.agent.stream_chunked_response(
            transcribed_text, 
            audio_callback=self._play_audio_chunk
        )
    
    async def _play_audio_chunk(self, audio_data: bytes, chunk_id: int):
        """Callback –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤"""
        filename = f"response_chunk_{chunk_id}"
        await self._convert_and_play_immediately(audio_data, filename)
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ chunked AI response:

- **Time to First Audio**: 0.8s (–≤–º–µ—Å—Ç–æ 10.7s)
- **Perceived Latency**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—ã—à–∏—Ç –Ω–∞—á–∞–ª–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ—á—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- **Parallel Processing**: TTS –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —á–∞–Ω–∫–∏ –ø–æ–∫–∞ –∏–≥—Ä–∞–µ—Ç —Ç–µ–∫—É—â–∏–π
- **UX Improvement**: –ë–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ –±–µ–∑ –¥–æ–ª–≥–∏—Ö –ø–∞—É–∑

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ chunk_id –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ TTS** - fallback –Ω–∞ HTTP TTS –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —á–∞–Ω–∫–æ–≤  
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é** - –æ—á–∏—â–∞–π—Ç–µ –±—É—Ñ–µ—Ä—ã –ø–æ—Å–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
4. **–ö–∞—á–µ—Å—Ç–≤–æ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏–∫—É `_is_sentence_complete()`

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª–∏—Ç –¥–æ—Å—Ç–∏—á—å –∑–∞—è–≤–ª–µ–Ω–Ω–æ–≥–æ **13x —É—Å–∫–æ—Ä–µ–Ω–∏—è** –∏ —Å–¥–µ–ª–∞–µ—Ç –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–º!

