# 📦 Инструкция по созданию бекапов проекта

## Быстрый старт

### Создать бекап:
```bash
cd /root/Asterisk_bot/BACKUP_START
./create_backup.sh
```

### Создать бекап с описанием:
```bash
cd /root/Asterisk_bot/BACKUP_START
./create_backup.sh
# Введите описание, например: "before_embeddings_optimization"
```

---

## Описание скрипта

Скрипт `create_backup.sh` создает сжатый архив (tar.gz) **ВСЕГО корня** `/root/Asterisk_bot/` и сохраняет его в папку `project_backup/`.

⚠️ **ВАЖНО:** Бекап содержит полную структуру `Asterisk_bot/...`, поэтому при восстановлении нужно извлекать из `/root/`, а не из `/root/Asterisk_bot/`!

### Что включается в бекап:
- ✅ Весь код проекта (`asterisk-vox-bot/`)
- ✅ **Виртуальное окружение** (`asterisk-vox-bot/venv/`) - для мгновенного восстановления
- ✅ **Векторная база** (`asterisk-vox-bot/data/chroma/`) - не нужно пересоздавать
- ✅ Документация в корне (`OPTIMIZATION_TASK_CLAUDE.md`, `README.md`)
- ✅ Папка со скриптами бекапа (`BACKUP_START/`)
- ✅ Все остальные файлы из `/root/Asterisk_bot/`

### Что исключается из бекапа:
- ❌ `project_backup/` - папка с бекапами (избегаем рекурсии)
- ❌ `.git/` - история Git (не нужна в бекапе)
- ❌ `__pycache__/`, `*.pyc` - скомпилированные файлы Python
- ❌ `asterisk-vox-bot/logs/` - логи бота (занимают много места)
- ❌ `restore_temp/` - временная папка восстановления

### 🔄 Автоматическая очистка:
Скрипт **автоматически удаляет старые бекапы**, оставляя только **последние 7**. Это предотвращает переполнение диска.

---

## Примеры использования

### 1. Обычный бекап
```bash
./create_backup.sh
# Создаст: backup_20251007_084530.tar.gz
```

### 2. Бекап с описанием
```bash
./create_backup.sh
# Введите: before_hybrid_filler
# Создаст: backup_before_hybrid_filler_20251007_084530.tar.gz
```

### 3. Автоматический бекап (без интерактива)
```bash
cd /root/Asterisk_bot/BACKUP_START
echo "" | ./create_backup.sh
# Создаст бекап без описания
```

---

## Восстановление из бекапа

### Посмотреть содержимое бекапа:
```bash
tar -tzf project_backup/backup_20251007_084530.tar.gz | head -20
```

### Восстановить весь бекап:
```bash
cd /root
tar -xzf Asterisk_bot/project_backup/backup_20251007_084530.tar.gz
```

**Примечание:** Архив содержит папку `Asterisk_bot/` целиком, поэтому извлекать нужно из `/root/`, и он восстановит `/root/Asterisk_bot/` со всем содержимым.

### Восстановить только файлы из корня проекта:
```bash
cd /root
tar -xzf Asterisk_bot/project_backup/backup_20251007_084530.tar.gz \
    Asterisk_bot/OPTIMIZATION_TASK_CLAUDE.md \
    Asterisk_bot/README.md \
    Asterisk_bot/create_backup.sh
```

### Восстановить конкретный файл из проекта:
```bash
cd /root
tar -xzf Asterisk_bot/project_backup/backup_20251007_084530.tar.gz \
    Asterisk_bot/asterisk-vox-bot/app/backend/asterisk/stasis_handler_optimized.py
```

### Восстановить только конфигурацию:
```bash
cd /root
tar -xzf Asterisk_bot/project_backup/backup_20251007_084530.tar.gz \
    Asterisk_bot/asterisk-vox-bot/.env \
    Asterisk_bot/asterisk-vox-bot/config/
```

---

## Управление бекапами

### Посмотреть все бекапы:
```bash
ls -lht /root/Asterisk_bot/project_backup/*.tar.gz
```

### Посмотреть размер папки с бекапами:
```bash
du -sh /root/Asterisk_bot/project_backup
```

### Удалить старые бекапы (старше 30 дней):
```bash
find /root/Asterisk_bot/project_backup -name "*.tar.gz" -mtime +30 -delete
```

⚠️ **ПРИМЕЧАНИЕ:** Скрипт `create_backup.sh` **автоматически** оставляет только последние 7 бекапов при каждом запуске, поэтому ручная очистка обычно не требуется.

### Удалить конкретный бекап:
```bash
rm /root/Asterisk_bot/project_backup/backup_20251007_084530.tar.gz
```

---

## Автоматизация бекапов

### Создать бекап по расписанию (cron)

Редактируем crontab:
```bash
crontab -e
```

Добавляем строки:

**Ежедневный бекап в 3:00 ночи:**
```cron
0 3 * * * cd /root/Asterisk_bot/BACKUP_START && echo "" | ./create_backup.sh > /dev/null 2>&1
```

**Бекап каждые 6 часов:**
```cron
0 */6 * * * cd /root/Asterisk_bot/BACKUP_START && echo "" | ./create_backup.sh > /dev/null 2>&1
```

**Бекап перед каждым перезапуском бота:**
```bash
# Создайте wrapper скрипт:
#!/bin/bash
cd /root/Asterisk_bot/BACKUP_START && echo "" | ./create_backup.sh
sudo systemctl restart asterisk-bot
```

---

## Проверка целостности бекапа

### Проверить архив на ошибки:
```bash
tar -tzf project_backup/backup_20251007_084530.tar.gz > /dev/null
echo $?  # Должно вернуть 0 если все ОК
```

### Сравнить бекап с текущей версией:
```bash
# Извлечь во временную папку
mkdir /tmp/backup_check
cd /tmp/backup_check
tar -xzf /root/Asterisk_bot/project_backup/backup_20251007_084530.tar.gz

# Сравнить весь репозиторий
diff -r /tmp/backup_check/Asterisk_bot /root/Asterisk_bot --exclude='project_backup'

# Или сравнить только проект
diff -r /tmp/backup_check/Asterisk_bot/asterisk-vox-bot /root/Asterisk_bot/asterisk-vox-bot

# Удалить временную папку
rm -rf /tmp/backup_check
```

---

## Хранение бекапов

### Рекомендации:
1. **Локальные бекапы:** Храните последние 3-5 бекапов на сервере
2. **Удаленные бекапы:** Копируйте важные бекапы на другой сервер или в облако
3. **Частота:** Создавайте бекап перед каждым значительным изменением
4. **Описание:** Всегда добавляйте описание для важных бекапов

### Копирование бекапа на удаленный сервер (scp):
```bash
scp /root/Asterisk_bot/project_backup/backup_20251007_084530.tar.gz \
    user@backup-server:/backups/asterisk-bot/
```

### Копирование в облако (Yandex Object Storage):
```bash
# Установка AWS CLI (совместим с Yandex Object Storage)
pip install awscli

# Настройка
aws configure --profile yandex
# Access Key: YOUR_ACCESS_KEY
# Secret Key: YOUR_SECRET_KEY
# Region: ru-central1
# Output: json

# Загрузка бекапа
aws s3 cp /root/Asterisk_bot/project_backup/backup_20251007_084530.tar.gz \
    s3://your-bucket/backups/ --profile yandex
```

---

## Troubleshooting

### Ошибка: "No space left on device"
```bash
# Проверить свободное место
df -h /root

# Удалить старые бекапы
cd /root/Asterisk_bot/project_backup
ls -t *.tar.gz | tail -n +4 | xargs rm -f

# Очистить логи бота
rm -f /root/Asterisk_bot/asterisk-vox-bot/logs/*.log
```

### Ошибка: "Permission denied"
```bash
# Сделать скрипт исполняемым
chmod +x /root/Asterisk_bot/create_backup.sh

# Проверить права на папку бекапов
chmod 755 /root/Asterisk_bot/project_backup
```

### Бекап создается слишком долго
```bash
# Проверить размер проекта
du -sh /root/Asterisk_bot/asterisk-vox-bot

# Если слишком большой, исключить больше папок
# Отредактируйте create_backup.sh, добавьте:
# --exclude='asterisk-vox-bot/data'
```

---

## Важные заметки

⚠️ **Внимание:**
- Бекапы НЕ включают `.env` файл с секретами (он исключен для безопасности)
- Перед восстановлением убедитесь, что у вас есть копия `.env`
- Всегда проверяйте целостность бекапа после создания
- Регулярно удаляйте старые бекапы для экономии места

✅ **Рекомендации:**
- Создавайте бекап перед каждым большим изменением
- Храните минимум 3 последних бекапа
- Копируйте критичные бекапы на удаленный сервер
- Используйте описательные имена для бекапов

---

**Автор:** Claude (Anthropic)  
**Дата создания:** 7 октября 2025  
**Версия:** 1.0



═══════════════════════════════════════════════════════════════════════════════
  📊 СХЕМА РАБОТЫ СКРИПТА create_backup.sh
═══════════════════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────────────────┐
│  1️⃣  ЗАПУСК СКРИПТА: ./create_backup.sh                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2️⃣  ВВОД ОПИСАНИЯ (опционально)                                            │
│     Пример: "before_production", "working_version", "test"                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3️⃣  ФОРМИРОВАНИЕ ИМЕНИ ФАЙЛА                                               │
│     backup_[описание]_[дата]_[время].tar.gz                                 │
│     Пример: backup_before_production_20251008_103045.tar.gz                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4️⃣  ПОДСЧЕТ РАЗМЕРА РЕПОЗИТОРИЯ                                            │
│     du -sb --exclude='project_backup' .                                     │
│     Показывает: Размер репозитория (без бекапов): 574MB                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  5️⃣  СОЗДАНИЕ АРХИВА                                                        │
│     tar -czf backup.tar.gz Asterisk_bot/                                    │
│                                                                              │
│     ✅ ВКЛЮЧАЕТСЯ:                                                          │
│     • asterisk-vox-bot/app/          (весь код)                            │
│     • asterisk-vox-bot/venv/         (виртуальное окружение ~550MB)        │
│     • asterisk-vox-bot/data/chroma/  (векторная база)                      │
│     • asterisk-vox-bot/config/       (конфигурация)                        │
│     • asterisk-vox-bot/kb/           (база знаний)                         │
│     • OPTIMIZATION_TASK_CLAUDE.md                                           │
│     • README.md, create_backup.sh, etc.                                     │
│                                                                              │
│     ❌ ИСКЛЮЧАЕТСЯ:                                                         │
│     • project_backup/  (папка с бекапами)                                  │
│     • .git/            (история Git)                                        │
│     • logs/            (логи бота)                                          │
│     • __pycache__/     (кеш Python)                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  6️⃣  ПРОВЕРКА УСПЕШНОСТИ                                                    │
│     • Проверка кода возврата tar                                            │
│     • Проверка существования файла                                          │
│     • Подсчет размера созданного архива                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  7️⃣  ВЫВОД ИНФОРМАЦИИ О БЕКАПЕ                                              │
│     📁 Файл:     backup_before_production_20251008_103045.tar.gz           │
│     📦 Размер:   151MB                                                      │
│     📍 Путь:     /root/Asterisk_bot/project_backup/...                     │
│     🕐 Время:    2025-10-08 10:30:45                                       │
│     📝 Описание: before_production                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  8️⃣  ПОКАЗ ПОСЛЕДНИХ 5 БЕКАПОВ                                              │
│     📦 backup_before_production_20251008_103045.tar.gz    151MB            │
│     📦 backup_test_20251008_084530.tar.gz                 151MB            │
│     📦 backup_toodey_20251007_062904.tar.gz               151MB            │
│     📦 backup_before_hybrid_20251006_113009.tar.gz        151MB            │
│     📦 backup_before_parallel_20251006_114221.tar.gz      151MB            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  9️⃣  АВТОМАТИЧЕСКАЯ ОЧИСТКА СТАРЫХ БЕКАПОВ                                  │
│                                                                              │
│     Подсчет: ls -1 *.tar.gz | wc -l                                        │
│                                                                              │
│     ┌────────────────────────────┬─────────────────────────────────────┐   │
│     │  Если бекапов ≤ 7          │  Если бекапов > 7                   │   │
│     ├────────────────────────────┼─────────────────────────────────────┤   │
│     │  ✅ Очистка не требуется   │  ⚠️  Удаляем старые:                │   │
│     │                             │                                      │   │
│     │  Показать сообщение:        │  1. Сортировать по дате (ls -t)    │   │
│     │  "Бекапов: 5 (лимит: 7)"   │  2. Взять все кроме 7 новейших     │   │
│     │                             │  3. Удалить каждый старый файл      │   │
│     │                             │  4. Показать что удалено            │   │
│     │                             │                                      │   │
│     │                             │  Пример:                            │   │
│     │                             │  🗑️  backup_old_1.tar.gz (151MB)   │   │
│     │                             │  🗑️  backup_old_2.tar.gz (151MB)   │   │
│     │                             │  🗑️  backup_old_3.tar.gz (151MB)   │   │
│     │                             │                                      │   │
│     │                             │  ✅ Очистка завершена               │   │
│     │                             │     Осталось бекапов: 7             │   │
│     └────────────────────────────┴─────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  🔟  ПРОВЕРКА СВОБОДНОГО МЕСТА                                               │
│     df -B1 /root/Asterisk_bot                                               │
│     Свободно на диске: 9GB                                                  │
│                                                                              │
│     Если < 1GB → ⚠️  Предупреждение: Мало места!                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  1️⃣1️⃣  ОПЦИЯ ПРОСМОТРА СОДЕРЖИМОГО                                             │
│     Показать содержимое бекапа? (y/N):                                      │
│                                                                              │
│     Если "y" → tar -tzf backup.tar.gz | head -50                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✅ ГОТОВО!                                                                  │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
  📈 СТАТИСТИКА ИСПОЛЬЗОВАНИЯ МЕСТА
═══════════════════════════════════════════════════════════════════════════════

Один бекап:        ~150 MB
Максимум бекапов:  7 штук
Итого:             ~1.05 GB

Свободно:          9 GB
Использование:     ~12% свободного места
Статус:            ✅ ОТЛИЧНО


═══════════════════════════════════════════════════════════════════════════════
  ⏱️  ВРЕМЯ ВЫПОЛНЕНИЯ
═══════════════════════════════════════════════════════════════════════════════

1. Подсчет размера:     ~1 сек
2. Создание архива:     ~5-10 сек (зависит от размера venv)
3. Проверка:            <1 сек
4. Вывод информации:    <1 сек
5. Автоочистка:         ~1-2 сек (если удаляются старые)

ИТОГО:                  ~10-15 секунд


═══════════════════════════════════════════════════════════════════════════════
  🔄 ВОССТАНОВЛЕНИЕ ИЗ БЕКАПА
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  1. Перейти в /root                                                         │
│     cd /root                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. Извлечь бекап                                                           │
│     tar -xzf Asterisk_bot/project_backup/backup_NAME.tar.gz                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. Перейти в проект                                                        │
│     cd /root/Asterisk_bot/asterisk-vox-bot                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. Активировать venv                                                       │
│     source venv/bin/activate                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  5. Запустить бота                                                          │
│     python app/backend/asterisk/stasis_handler_optimized.py                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✅ БОТ РАБОТАЕТ! (без установки зависимостей)                              │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════

