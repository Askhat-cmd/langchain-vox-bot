# —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã,
# –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ —Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –Ω–µ–º—É.
# –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞: python test_agent.py

'''
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç ‚Äî –≤–∞—à –ª–∏—á–Ω—ã–π "–∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä –∫–∞—á–µ—Å—Ç–≤–∞". –ï–≥–æ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å **–∫–∞–∂–¥—ã–π —Ä–∞–∑** –ø–æ—Å–ª–µ —Ç–æ–≥–æ,
–∫–∞–∫ –≤—ã:

1.  **–û–±–Ω–æ–≤–ª—è–µ—Ç–µ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π** (`knowledge_base.md`).
2.  **–ò–∑–º–µ–Ω—è–µ—Ç–µ –ø—Ä–æ–º–ø—Ç—ã** (—á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ `prompts.json`).

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –≤–∞–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–æ—Ç –Ω–µ "—Ä–∞–∑—É—á–∏–ª—Å—è"
–æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∏ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è, –≤—ã —Å—Ä–∞–∑—É –ø–æ–π–º–µ—Ç–µ,
—á—Ç–æ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –∏ —Å–º–æ–∂–µ—Ç–µ –≤–æ–≤—Ä–µ–º—è —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.
–≠—Ç–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ä—É—Ç–∏–Ω–Ω—É—é —Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –±—ã—Å—Ç—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å.
'''

import asyncio
import os
import sys
import uuid
import logging
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Agent
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –º–µ–Ω—å—à–µ —Å–ø–∞–º–∞ –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫
logging.basicConfig(level=logging.WARNING)
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å INFO —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞—à–µ–≥–æ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)

try:
    from Agent import Agent
except ImportError as e:
    print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —á—Ç–æ –ø—É—Ç—å –∫ Agent.py –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.")
    sys.exit(1)

# --- –¢–ï–°–¢–û–í–´–ï –°–õ–£–ß–ê–ò (–û–î–ò–ù–û–ß–ù–´–ï) ---
# –ü—Ä–æ–≤–µ—Ä—è—é—Ç –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è –±–æ—Ç–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–µ–º–∞–º.
SINGLE_CASES = [
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤",
        "question": "–ö–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–µ–±–µ–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –≤–∞—à–µ–º –º–∞–≥–∞–∑–∏–Ω–µ?",
        "expected_keywords": ["–¥–∏–≤–∞–Ω—ã", "–∫—Ä–µ—Å–ª–∞", "–ø—É—Ñ—ã", "–±–∞–Ω–∫–µ—Ç–∫–∏"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–æ–≤ –¥–∏–≤–∞–Ω–æ–≤",
        "question": "–ö–∞–∫–∏–µ –≤–∏–¥—ã –¥–∏–≤–∞–Ω–æ–≤ —É –≤–∞—Å –µ—Å—Ç—å?",
        "expected_keywords": ["–ø—Ä—è–º—ã–µ", "—É–≥–ª–æ–≤—ã–µ", "–¥–∏–≤–∞–Ω—ã-–∫—Ä–æ–≤–∞—Ç–∏"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è —É–≥–ª–æ–≤—ã—Ö –¥–∏–≤–∞–Ω–æ–≤",
        "question": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ —É–≥–ª–æ–≤—ã–µ –¥–∏–≤–∞–Ω—ã",
        "expected_keywords": ["–ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–µ", "–±–æ–ª—å—à–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π", "–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–∞–ª–µ–π –æ –¥–∏–≤–∞–Ω–µ ¬´–ö–ª–∞—Å—Å–∏–∫¬ª",
        "question": "–ß—Ç–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∏–≤–∞–Ω–∞ ¬´–ö–ª–∞—Å—Å–∏–∫¬ª?",
        "expected_keywords": ["—Å–æ—Å–Ω—ã", "–±–æ–Ω–Ω–µ–ª—å", "–∫–Ω–∏–∂–∫–∞", "200—Ö140", "—è—â–∏–∫", "45000"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–∞–ª–µ–π –æ –¥–∏–≤–∞–Ω–µ ¬´–ú–æ–¥–µ—Ä–Ω –ü–ª—é—Å¬ª",
        "question": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –¥–∏–≤–∞–Ω ¬´–ú–æ–¥–µ—Ä–Ω –ü–ª—é—Å¬ª –∏ –µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏",
        "expected_keywords": ["–µ–≤—Ä–æ–∫–Ω–∏–∂–∫–∞", "—Ç–µ—Ñ–ª–æ–Ω–æ–≤–æ–π", "–ø–æ–¥—É—à–∫–∏-–≤–∞–ª–∏–∫–∏"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–∞–ª–µ–π –æ –¥–∏–≤–∞–Ω–µ ¬´–ü—Ä–µ—Å—Ç–∏–∂ –õ—é–∫—Å¬ª",
        "question": "–ß–µ–º –æ—Å–æ–±–µ–Ω–µ–Ω –¥–∏–≤–∞–Ω ¬´–ü—Ä–µ—Å—Ç–∏–∂ –õ—é–∫—Å¬ª?",
        "expected_keywords": ["pocket spring", "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º", "–Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–π –∫–æ–∂–∏", "–ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö –¥–∏–≤–∞–Ω–æ–≤",
        "question": "–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –Ω–µ–±–æ–ª—å—à–æ–π —É–≥–ª–æ–≤–æ–π –¥–∏–≤–∞–Ω –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –∫–æ–º–Ω–∞—Ç—ã",
        "expected_keywords": ["–∫–æ–º–ø–∞–∫—Ç", "–≤—ã–∫–∞—Ç–Ω–æ–π", "180—Ö120", "–º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã –¥–∏–≤–∞–Ω–∞ ¬´–ü—Ä–µ—Å—Ç–∏–∂ –õ—é–∫—Å¬ª",
        "question": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –¥–∏–≤–∞–Ω ¬´–ü—Ä–µ—Å—Ç–∏–∂ –õ—é–∫—Å¬ª?",
        "expected_keywords": ["125000", "—Ä—É–±–ª–µ–π"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–≤–µ—Ç–æ–≤ –¥–∏–≤–∞–Ω–∞ ¬´–≠–∫–æ–Ω–æ–º –°—Ç–∞–Ω–¥–∞—Ä—Ç¬ª",
        "question": "–í –∫–∞–∫–∏—Ö —Ü–≤–µ—Ç–∞—Ö –≤—ã–ø—É—Å–∫–∞–µ—Ç—Å—è –º–æ–¥–µ–ª—å ¬´–≠–∫–æ–Ω–æ–º –°—Ç–∞–Ω–¥–∞—Ä—Ç¬ª?",
        "expected_keywords": ["—Å–µ—Ä—ã–π", "–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", "—Å–∏–Ω–∏–π", "—Å–µ—Ä–æ-–≥–æ–ª—É–±–æ–π"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏",
        "question": "–ö–∞–∫–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —É –¥–∏–≤–∞–Ω–∞ ¬´–ù–æ—á–Ω–æ–π –ö–æ–º—Ñ–æ—Ä—Ç¬ª?",
        "expected_keywords": ["–¥–µ–ª—å—Ñ–∏–Ω"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å–±–æ—Ä–∫–∏",
        "question": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å–±–æ—Ä–∫–∏.",
        "expected_keywords": ["30000", "–±–µ—Å–ø–ª–∞—Ç–Ω", "–ø–æ–¥—ä–µ–º –Ω–∞ —ç—Ç–∞–∂", "—Å–±–æ—Ä–∫–∞", "2 –≥–æ–¥–∞"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–∞—Ä–∞–Ω—Ç–∏–∏",
        "question": "–ö–∞–∫—É—é –≥–∞—Ä–∞–Ω—Ç–∏—é –≤—ã –¥–∞—ë—Ç–µ –Ω–∞ –º–µ–±–µ–ª—å?",
        "expected_keywords": ["2 –¥–æ 5 –ª–µ—Ç", "2 –≥–æ–¥–∞", "5 –ª–µ—Ç"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏",
        "question": "–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ?",
        "expected_keywords": ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–±–∞–Ω–∫–æ–≤—Å–∫", "—Ä–∞—Å—Å—Ä–æ—á–∫–∞", "24", "–±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –º–µ–±–µ–ª–∏",
        "question": "–ö–∞–∫ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ –º–µ–±–µ–ª–∏?",
        "expected_keywords": ["3 –Ω–µ–¥–µ–ª–∏", "15", "30%"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–∞",
        "question": "–ö–∞–∫–æ–π —É –≤–∞—Å –∞–¥—Ä–µ—Å?",
        "expected_keywords": ["—É–ª. –º–µ–±–µ–ª—å–Ω–∞—è, 25"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞",
        "question": "–°–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞",
        "expected_keywords": ["495", "123-45-67"]
    },
    {
        "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã",
        "question": "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞",
        "expected_keywords": ["10:00", "21:00"]
    }
]

# --- –°–¶–ï–ù–ê–†–ù–´–ï –¢–ï–°–¢–´ ---
# –ü—Ä–æ–≤–µ—Ä—è—é—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞.
SCENARIO_CASES = [
    {
        "name": "–°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–¥–±–æ—Ä –¥–∏–≤–∞–Ω–∞ –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–Ω–∞ –≤ —Å–µ–º—å–µ",
        "steps": [
            {
                "question": "–ù—É–∂–µ–Ω –¥–∏–≤–∞–Ω-–∫—Ä–æ–≤–∞—Ç—å –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–Ω–∞.",
                "expected_keywords": ["–¥–∏–≤–∞–Ω—ã-–∫—Ä–æ–≤–∞—Ç–∏", "–µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–Ω–∞", "–Ω–æ—á–Ω–æ–π –∫–æ–º—Ñ–æ—Ä—Ç"]
            },
            {
                "question": "–£ –Ω–∞—Å —Å–µ–º—å—è —Å —Ä–µ–±—ë–Ω–∫–æ–º, —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã —É—á–µ—Å—Ç—å —ç—Ç–æ.",
                "expected_keywords": ["—Å–µ–º–µ–π–Ω–æ–µ –≥–Ω–µ–∑–¥–æ", "–¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è", "250 –∫–≥"]
            }
        ]
    },
    {
        "name": "–°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–¥–±–æ—Ä –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —É–≥–ª–æ–≤–æ–≥–æ –¥–∏–≤–∞–Ω–∞",
        "steps": [
            {
                "question": "–ú–Ω–µ –Ω—É–∂–µ–Ω –Ω–µ–±–æ–ª—å—à–æ–π —É–≥–ª–æ–≤–æ–π –¥–∏–≤–∞–Ω –≤ –º–∞–ª–µ–Ω—å–∫—É—é –∫–æ–º–Ω–∞—Ç—É.",
                "expected_keywords": ["–∫–æ–º–ø–∞–∫—Ç", "–º–µ—Å—Ç–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏—è"]
            },
            {
                "question": "–ê –µ–≥–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –∫—Ä–æ–≤–∞—Ç—å?",
                "expected_keywords": ["–≤—ã–∫–∞—Ç–Ω–æ–π", "180—Ö120"]
            },
            {
                "question": "–ò —Å–∫–æ–ª—å–∫–æ –æ–Ω —Å—Ç–æ–∏—Ç?",
                "expected_keywords": ["54000", "—Ä—É–±–ª–µ–π"]
            }
        ]
    },
    {
        "name": "–°—Ü–µ–Ω–∞—Ä–∏–π: –í—ã–±–æ—Ä –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–≤–∞–Ω–∞ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π",
        "steps": [
            {
                "question": "–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –¥–∏–≤–∞–Ω –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ.",
                "expected_keywords": ["–∫–ª–∞—Å—Å–∏–∫", "–≤–µ–ª—é—Ä–∞", "—ç–∫–æ–∫–æ–∂–∏"]
            },
            {
                "question": "–û–Ω —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –∫—Ä–æ–≤–∞—Ç—å?",
                "expected_keywords": ["–∫–Ω–∏–∂–∫–∞", "200—Ö140", "—è—â–∏–∫"]
            },
            {
                "question": "–°–∫–æ–ª—å–∫–æ –æ–Ω —Å—Ç–æ–∏—Ç?",
                "expected_keywords": ["45000", "—Ä—É–±–ª–µ–π"]
            }
        ]
    },
    {
        "name": "–°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–¥–±–æ—Ä –æ—Ñ–∏—Å–Ω–æ–≥–æ –∫—Ä–µ—Å–ª–∞ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è",
        "steps": [
            {
                "question": "–ù—É–∂–Ω–æ —Å–æ–ª–∏–¥–Ω–æ–µ –æ—Ñ–∏—Å–Ω–æ–µ –∫—Ä–µ—Å–ª–æ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞.",
                "expected_keywords": ["–¥–∏—Ä–µ–∫—Ç–æ—Ä –ø—Ä–µ–º–∏—É–º", "–∫–æ–∂–∞ –Ω–∞–ø–ø–∞", "–∞–ª—é–º–∏–Ω–∏–µ–≤–æ–≥–æ"]
            },
            {
                "question": "–ê —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ, –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ–µ?",
                "expected_keywords": ["–∂–µ–Ω–µ–≤–∞", "–º–∞—Å—Å–∏–≤ –±—É–∫–∞", "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫"]
            },
            {
                "question": "–°–∫–æ–ª—å–∫–æ –æ–Ω–æ —Å—Ç–æ–∏—Ç?",
                "expected_keywords": ["67000", "—Ä—É–±–ª–µ–π"]
            }
        ]
    }
]


async def run_single_test(agent: Agent, test_case: dict, session_id: str) -> bool:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–¥–∏–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–ª—É—á–∞–π –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""
    question = test_case["question"]
    expected_keywords = test_case["expected_keywords"]

    logger.info(f"‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: '{test_case['name']}'")
    logger.info(f"   - –í–æ–ø—Ä–æ—Å: \"{question}\"")

    response_generator = agent.get_response_generator(question, session_id)

    full_response = ""
    for chunk in response_generator:
        if chunk:
            full_response += chunk

    full_response_lower = full_response.lower()
    logger.info(f"   - –û—Ç–≤–µ—Ç –±–æ—Ç–∞: \"{full_response.strip()}\"")

    missing_keywords = [kw for kw in expected_keywords if kw.lower() not in full_response_lower]

    if not missing_keywords:
        logger.info(f"   ‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù\n")
        return True
    else:
        logger.error(f"   ‚ùå –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù. –ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {missing_keywords}\n")
        return False

async def run_scenario_test(agent: Agent, test_case: dict, session_id: str) -> bool:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–¥–∏–Ω —Å—Ü–µ–Ω–∞—Ä–Ω—ã–π —Ç–µ—Å—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""
    logger.info(f"‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è: '{test_case['name']}'")
    scenario_passed = True

    for i, step in enumerate(test_case["steps"]):
        question = step["question"]
        expected_keywords = step["expected_keywords"]
        logger.info(f"   - –®–∞–≥ {i+1}: \"{question}\"")

        response_generator = agent.get_response_generator(question, session_id)

        step_response = ""
        for chunk in response_generator:
            if chunk:
                step_response += chunk

        step_response_lower = step_response.lower()
        logger.info(f"   - –û—Ç–≤–µ—Ç –±–æ—Ç–∞: \"{step_response.strip()}\"")

        missing_keywords = [kw for kw in expected_keywords if kw.lower() not in step_response_lower]

        if missing_keywords:
            logger.error(f"   ‚ùå –®–ê–ì {i+1} –ü–†–û–í–ê–õ–ï–ù. –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å–ª–æ–≤–∞: {missing_keywords}")
            scenario_passed = False
        else:
            logger.info(f"   ‚úÖ –®–∞–≥ {i+1} –ø—Ä–æ–π–¥–µ–Ω.")

    if scenario_passed:
        logger.info(f"   ‚úÖ –°–¶–ï–ù–ê–†–ò–ô –ü–†–û–ô–î–ï–ù\n")
        return True
    else:
        logger.error(f"   ‚ùå –°–¶–ï–ù–ê–†–ò–ô –ü–†–û–í–ê–õ–ï–ù.\n")
        return False


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤."""
    load_dotenv()

    logger.info("="*50)
    logger.info("üöÄ –ù–ê–ß–ê–õ–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø AI-–ê–ì–ï–ù–¢–ê üöÄ")
    logger.info("="*50)

    try:
        agent = Agent()
    except Exception as e:
        logger.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≥–µ–Ω—Ç–∞: {e}", exc_info=True)
        return

    results = {"passed": 0, "failed": 0}
    total_tests = len(SINGLE_CASES) + len(SCENARIO_CASES)

    # –ó–∞–ø—É—Å–∫ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    logger.info("\n--- –û–î–ò–ù–û–ß–ù–´–ï –¢–ï–°–¢–´ ---\n")
    for test_case in SINGLE_CASES:
        session_id = f"test-session-{uuid.uuid4()}" # –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
        is_passed = await run_single_test(agent, test_case, session_id)
        if is_passed:
            results["passed"] += 1
        else:
            results["failed"] += 1

    # –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    logger.info("\n--- –°–¶–ï–ù–ê–†–ù–´–ï –¢–ï–°–¢–´ (–ö–û–ù–¢–ï–ö–°–¢) ---\n")
    for test_case in SCENARIO_CASES:
        session_id = f"test-session-{uuid.uuid4()}" # –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        is_passed = await run_scenario_test(agent, test_case, session_id)
        if is_passed:
            results["passed"] += 1
        else:
            results["failed"] += 1

    logger.info("="*50)
    logger.info("üèÅ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û üèÅ")
    logger.info("="*50)
    logger.info(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
    logger.info(f"   - ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: {results['passed']} –∏–∑ {total_tests}")
    logger.info(f"   - ‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {results['failed']} –∏–∑ {total_tests}")
    logger.info("="*50)

    if results["failed"] > 0:
        logger.warning("–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –±—ã–ª–∏ –ø—Ä–æ–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ.")
        sys.exit(1) # –í—ã—Ö–æ–¥–∏–º —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    else:
        logger.info("üéâ –í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!")


if __name__ == "__main__":
    # –î–ª—è Windows –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞
    if sys.platform == "win32":
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

    asyncio.run(main())
