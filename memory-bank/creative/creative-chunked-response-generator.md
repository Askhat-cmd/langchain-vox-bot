# üé® CREATIVE PHASE: CHUNKED RESPONSE GENERATOR ARCHITECTURE

**–î–∞—Ç–∞:** 2025-01-27  
**–¢–∏–ø:** Architecture Design  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç AI –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º TTS, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É 2.74 —Å–µ–∫—É–Ω–¥—ã. –ù—É–∂–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è streaming chunking –ø–æ —Å–∏–º–≤–æ–ª—É "|" –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ TTS –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

## üìã –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —á–∞–Ω–∫–∞–º —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º "|"
- –ü–µ—Ä–≤—ã–π —á–∞–Ω–∫ –≥–æ—Ç–æ–≤ —á–µ—Ä–µ–∑ 0.6-0.8—Å –æ—Ç –Ω–∞—á–∞–ª–∞ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
- Fallback –Ω–∞ –ø–æ–ª–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º Agent –∫–ª–∞—Å—Å–æ–º
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WebSocket –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —á–∞–Ω–∫–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ "|", –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞: <0.8—Å
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
- –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å: 99%+ —É—Å–ø–µ—à–Ω—ã—Ö chunking –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üîç –ê–ù–ê–õ–ò–ó –í–ê–†–ò–ê–ù–¢–û–í

### –í–ê–†–ò–ê–ù–¢ 1: –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û get_response_generator

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å chunking –ª–æ–≥–∏–∫—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ü–ª—é—Å—ã:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WebSocket
- –ù–∏–∑–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ú–∏–Ω—É—Å—ã:**
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≥–∏–±–∫–æ—Å—Ç—å –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ chunking
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ chunking –ª–æ–≥–∏–∫–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2-3 —á–∞—Å–∞

### –í–ê–†–ò–ê–ù–¢ 2: –û–¢–î–ï–õ–¨–ù–´–ô CHUNKED GENERATOR –°–ï–†–í–ò–°

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è chunked –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ü–ª—é—Å—ã:**
- –ü–æ–ª–Ω–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ chunking
- –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ú–∏–Ω—É—Å—ã:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –ë–æ–ª—å—à–µ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 6-8 —á–∞—Å–æ–≤

### –í–ê–†–ò–ê–ù–¢ 3: –ì–ò–ë–†–ò–î–ù–´–ô –ü–û–î–•–û–î –° CHUNKING MIDDLEWARE

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å middleware —Å–ª–æ–π –º–µ–∂–¥—É Agent –∏ WebSocket

**–ü–ª—é—Å—ã:**
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –õ–µ–≥–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É chunked –∏ –æ–±—ã—á–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ chunking –ª–æ–≥–∏–∫–∏

**–ú–∏–Ω—É—Å—ã:**
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ middleware

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 4-5 —á–∞—Å–æ–≤

---

## ‚öñÔ∏è –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –í–∞—Ä–∏–∞–Ω—Ç 1 | –í–∞—Ä–∏–∞–Ω—Ç 2 | –í–∞—Ä–∏–∞–Ω—Ç 3 |
|----------|-----------|-----------|-----------|
| **–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê |
| **–ì–∏–±–∫–æ—Å—Ç—å** | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê |
| **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï: –í–ê–†–ò–ê–ù–¢ 1

### –û–ë–û–°–ù–û–í–ê–ù–ò–ï –í–´–ë–û–†–ê:

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
2. **–ë—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** 2-3 —á–∞—Å–∞ –≤–º–µ—Å—Ç–æ 6-8 —á–∞—Å–æ–≤
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ
4. **–í—ã—Å–æ–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ WebSocket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏

---

## üîß –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è chunking
```python
# prompts.json
{
  "qa_system_prompt": "–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –ú–µ—Ç—Ä–æ—Ç–µ—Å—Ç.| –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –¥–æ 15 —Å–ª–æ–≤.| –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Å–∏–º–≤–æ–ª–æ–º ¬´|¬ª –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ–∑–≤—É—á–∫–∏.|\n\n## –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:\n'–î–ª—è –º–µ—Ç–∞–ª–ª–æ–≤ –¥–æ 600 –∫–ù –ø–æ–¥–æ–π–¥–µ—Ç –†–≠–ú-600-–ê.| –¢–æ—á–Ω–æ—Å—Ç—å ¬±0,5% –ø–æ ISO 7500-1.| –ú–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫—É—é –†–ì–ú-1000-–ê.| –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ö–ü –∏–ª–∏ –¥–µ–º–æ-–∏—Å–ø—ã—Ç–∞–Ω–∏–µ?|'\n\n{context}"
}
```

### –®–∞–≥ 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è get_chunked_response_generator
```python
def get_chunked_response_generator(self, user_question: str, session_id: str):
    """
    –Ø–î–†–û –°–ò–°–¢–ï–ú–´: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–∞–Ω–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ —Å–∏–º–≤–æ–ª—É '|' –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ TTS.
    """
    response_stream = self.get_response_generator(user_question, session_id)
    
    buffer = ""
    chunk_count = 0
    start_time = time.time()
    
    try:
        for token in response_stream:
            buffer += token
            
            # –ö–†–ò–¢–ò–ß–ù–û: –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞—à–ª–∏ '|' - –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞–Ω–∫
            while "|" in buffer:
                chunk_end = buffer.find("|")
                sentence = buffer[:chunk_end].strip()
                buffer = buffer[chunk_end + 1:]
                
                if sentence:
                    chunk_count += 1
                    elapsed = time.time() - start_time
                    
                    # –ü–ï–†–í–´–ô –ß–ê–ù–ö - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –º–µ—Ç—Ä–∏–∫–∞
                    if chunk_count == 1:
                        logger.info(f"üéØ FIRST CHUNK TIME: {elapsed:.2f}s (target: <0.8s)")
                    
                    yield {
                        "text": sentence,
                        "chunk_number": chunk_count,
                        "elapsed_time": elapsed,
                        "is_first": chunk_count == 1
                    }
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –±—É—Ñ–µ—Ä–∞ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
        if buffer.strip():
            chunk_count += 1
            yield {
                "text": buffer.strip(),
                "chunk_number": chunk_count,
                "is_final": True
            }
            
    except Exception as e:
        logger.error(f"‚ùå Chunked generator error: {e}")
        # Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
        full_response = ""
        for token in self.get_response_generator(user_question, session_id):
            full_response += token
        yield {
            "text": full_response,
            "chunk_number": 1,
            "fallback": True
        }
```

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WebSocket
```python
# –û–±–Ω–æ–≤–∏—Ç—å WebSocket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —á–∞–Ω–∫–æ–≤
async def handle_chunked_response(self, user_question: str, session_id: str):
    async for chunk_data in self.agent.get_chunked_response_generator(user_question, session_id):
        await self.websocket.send({
            "type": "chunk",
            "data": chunk_data
        })
```

---

## üèóÔ∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
```mermaid
graph TD
    subgraph "CHUNKED RESPONSE ARCHITECTURE"
    WS["WebSocket Handler"] --> AG["Agent.get_chunked_response_generator()"]
    AG --> RS["Response Stream"]
    RS --> CP["Chunk Processor"]
    CP --> CB["Chunk Buffer"]
    CB --> |"| found"| CY["Yield Chunk"]
    CY --> WS
    
    AG --> |"Error"| FB["Fallback Generator"]
    FB --> WS
    end
    
    style AG fill:#4dbb5f,stroke:#36873f,color:white
    style CP fill:#ffa64d,stroke:#cc7a30,color:white
    style CY fill:#d94dbb,stroke:#a3378a,color:white
    style FB fill:#4dbbbb,stroke:#368787,color:white
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
```mermaid
sequenceDiagram
    participant WS as WebSocket
    participant AG as Agent
    participant CP as Chunk Processor
    participant TTS as TTS Service
    
    WS->>AG: get_chunked_response_generator()
    AG->>CP: Stream tokens
    CP->>CP: Buffer until "|"
    CP->>WS: Yield chunk 1
    WS->>TTS: Start TTS for chunk 1
    CP->>CP: Continue buffering
    CP->>WS: Yield chunk 2
    WS->>TTS: Start TTS for chunk 2
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —á–∞–Ω–∫–∞–º —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º "|"
- ‚úÖ –ü–µ—Ä–≤—ã–π —á–∞–Ω–∫ –≥–æ—Ç–æ–≤ —á–µ—Ä–µ–∑ 0.6-0.8—Å –æ—Ç –Ω–∞—á–∞–ª–∞ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ Fallback –Ω–∞ –ø–æ–ª–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º Agent –∫–ª–∞—Å—Å–æ–º
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WebSocket –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —á–∞–Ω–∫–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ "|", –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- ‚úÖ –í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞: <0.8—Å
- ‚úÖ –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å: 99%+ —É—Å–ø–µ—à–Ω—ã—Ö chunking –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –†–ï–®–ï–ù–ò–ï –ü–†–ò–ù–Ø–¢–û –ò –î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–û**

–í—ã–±—Ä–∞–Ω **–í–ê–†–ò–ê–ù–¢ 1: –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û get_response_generator** –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∏—Å–∫–∞, –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã—Å–æ–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º.

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã gRPC TTS –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

