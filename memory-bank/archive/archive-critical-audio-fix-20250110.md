# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–í–û–ô–ù–´–ï WAV –ó–ê–ì–û–õ–û–í–ö–ò

**–î–∞—Ç–∞:** 10 —è–Ω–≤–∞—Ä—è 2025  
**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –∞—É–¥–∏–æ –æ—Ç Yandex gRPC TTS  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

## üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–†–´–¢–ò–ï

**–ü—Ä–æ–±–ª–µ–º–∞:** Yandex gRPC TTS –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç raw LPCM –¥–∞–Ω–Ω—ã–µ –±–µ–∑ WAV –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –Ω–æ –∫–æ–¥ –Ω–µ –¥–æ–±–∞–≤–ª—è–ª –∑–∞–≥–æ–ª–æ–≤–∫–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤ Asterisk.

**–°–∏–º–ø—Ç–æ–º—ã:**
- ‚úÖ TTS —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ (0.16s)
- ‚úÖ –§–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è (191334 bytes)
- ‚úÖ ARI –ø—Ä–∏–Ω–∏–º–∞–µ—Ç (status=201)
- ‚ùå Playback –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–ª—ã—à–∏—Ç –∑–≤—É–∫

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

**–ê–Ω–∞–ª–∏–∑ hex –¥–∞–º–ø–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤:**
```bash
hexdump -C /var/lib/asterisk/sounds/stream_1757489735.40_073632149.gsm | head -3
00000000  d8 20 a2 e1 5a 50 00 49  24 92 49 24 50 00 49 24  |. ..ZP.I$.I$P.I$|
00000010  92 49 24 50 00 49 24 92  49 24 50 00 49 24 92 49  |.I$P.I$.I$P.I$.I|
00000020  24 d8 20 a2 e1 5a 50 00  49 24 92 49 24 50 00 49  |$. ..ZP.I$.I$P.I|
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–ï–¢ RIFF –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ - —ç—Ç–æ raw LPCM –¥–∞–Ω–Ω—ã–µ!

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_play_audio_data`

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:**
```python
# üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
header = audio_data[:12]

if header.startswith(b'RIFF') and b'WAVE' in header:
    # ‚úÖ –£–∂–µ –≥–æ—Ç–æ–≤—ã–π WAV —Ñ–∞–π–ª - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    logger.info("‚úÖ WAV —Ñ–∞–π–ª —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å")
    with open(temp_path, 'wb') as f:
        f.write(audio_data)
else:
    # üîÑ Raw LPCM - –¥–æ–±–∞–≤–ª—è–µ–º WAV –∑–∞–≥–æ–ª–æ–≤–∫–∏
    logger.info("üîÑ Raw LPCM - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WAV")
    await self._convert_lpcm_to_wav(audio_data, temp_path)
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_convert_lpcm_to_wav`

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è Asterisk:**
```python
async def _convert_lpcm_to_wav(self, lpcm_data: bytes, output_path: str):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç raw LPCM –≤ WAV —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –¥–ª—è Asterisk"""
    try:
        import wave
        
        # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Asterisk
        sample_rate = 8000  # 8kHz –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        channels = 1        # mono
        sample_width = 2    # 16-bit
        
        with wave.open(output_path, 'wb') as wav_file:
            wav_file.setnchannels(channels)
            wav_file.setsampwidth(sample_width)
            wav_file.setframerate(sample_rate)
            wav_file.writeframes(lpcm_data)
        
        logger.info(f"üîÑ LPCM –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ WAV: {output_path}")
        logger.info(f"üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {sample_rate}Hz, {channels}ch, {sample_width*8}bit")
        
    except Exception as e:
        logger.error(f"‚ùå LPCM to WAV conversion error: {e}")
        # Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        with open(output_path, 'wb') as f:
            f.write(lpcm_data)
```

## üìä –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Asterisk:**
- **–ß–∞—Å—Ç–æ—Ç–∞:** 8000 Hz (–≤–º–µ—Å—Ç–æ 16000 Hz)
- **Bit depth:** 16-bit
- **–ö–∞–Ω–∞–ª—ã:** mono (1 –∫–∞–Ω–∞–ª)
- **–§–æ—Ä–º–∞—Ç:** signed PCM

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ—É—á—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Asterisk
- ‚úÖ –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:**
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è LPCM ‚Üí WAV
3. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Asterisk
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- üéµ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç —Å–ª—ã—à–∞—Ç—å —Ä–µ—á—å –æ—Ç TTS
- ‚ö° –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ (0.16s —Å–∏–Ω—Ç–µ–∑ + –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
- üîß –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å Asterisk

## üìÅ –§–ê–ô–õ–´ –ò–ó–ú–ï–ù–ï–ù–´

- `app/backend/asterisk/stasis_handler_optimized.py`
  - –ú–µ—Ç–æ–¥ `_play_audio_data` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
  - –ú–µ—Ç–æ–¥ `_convert_lpcm_to_wav` - –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É TTS —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã TTS

---

**MISSION ACCOMPLISHED!** üéØ  
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –∞—É–¥–∏–æ —Ä–µ—à–µ–Ω–∞!
