# üöÄ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò AI –ì–û–õ–û–°–û–í–û–ì–û –ë–û–¢–ê

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° –ü–†–û–ï–ö–¢–ê

### ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_max_relevance()` (—ç–∫–æ–Ω–æ–º–∏—è 6.4+ —Å–µ–∫)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `agent.py` –∏ `stasis_handler.py`
- –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ RAG

### ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´:
- **AI Streaming**: 9.5 —Å–µ–∫—É–Ω–¥ (—Ü–µ–ª–µ–≤–æ–µ: 2-3 —Å–µ–∫)
- **gRPC TTS**: –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, fallback –Ω–∞ HTTP (0.5 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 0.1 —Å–µ–∫)
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ embedding –∑–∞–ø—Ä–æ—Å—ã**: 3-4 –∑–∞–ø—Ä–æ—Å–∞ –ø–æ 0.5-1 —Å–µ–∫ –∫–∞–∂–¥—ã–π
- **–£—Å—Ç–∞—Ä–µ–≤—à–∞—è ChromaDB**: deprecation warnings

## üéØ –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê –ò –§–ê–ô–õ–´

### –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```
/etc/asterisk/extensions.conf ‚Üí Stasis(asterisk-bot)
    ‚Üì
app/backend/asterisk/stasis_handler.py (ARI WebSocket)
    ‚Üì
app/backend/asterisk/ari_client.py (Answer, Record, Play)
    ‚Üì
app/backend/services/asr_service.py (OpenAI Whisper)
    ‚Üì
app/backend/utils/text_normalizer.py (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)
    ‚Üì
app/backend/rag/agent.py (RAG + ChromaDB + OpenAI GPT)
    ‚Üì
app/backend/services/yandex_tts_service.py (Yandex TTS)
    ‚Üì
app/backend/asterisk/ari_client.py (Playback)
    ‚Üì
app/backend/services/log_storage.py (SQLite –ª–æ–≥)
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `config/prompts.json` - –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è AI
- `kb/general.md`, `kb/tech.md` - –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
- `scripts/create_embeddings.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã
- `data/chroma/` - ChromaDB –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞
- `data/db/log_db.sqlite` - –ª–æ–≥–∏ –∑–≤–æ–Ω–∫–æ–≤

## üîß –ü–õ–ê–ù –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –ü–û –≠–¢–ê–ü–ê–ú

### –≠–¢–ê–ü 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (2-4 —á–∞—Å–∞)

#### 1.1 –ò—Å–ø—Ä–∞–≤–∏—Ç—å gRPC TTS (—ç–∫–æ–Ω–æ–º–∏—è 0.4 —Å–µ–∫)
**–§–∞–π–ª**: `app/backend/services/yandex_tts_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞**: 
```python
# –û–®–ò–ë–ö–ê:
module 'yandex.cloud.ai.tts.v3.tts_service_pb2' has no attribute 'UtteranceSynthesisRequest'
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å proto —Ñ–∞–π–ª—ã
cd /root/Asterisk_bot/asterisk-vox-bot/app/backend/services/
python -m grpc_tools.protoc \
    --python_out=. \
    --grpc_python_out=. \
    yandex/cloud/ai/tts/v3/*.proto

# 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ yandex_tts_service.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: gRPC TTS —Ä–∞–±–æ—Ç–∞–µ—Ç, –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å 0.1 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 0.5 —Å–µ–∫

#### 1.2 –î–æ–±–∞–≤–∏—Ç—å Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ embeddings (—ç–∫–æ–Ω–æ–º–∏—è 1-2 —Å–µ–∫)
**–§–∞–π–ª**: `app/backend/rag/agent.py`

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**:
```bash
sudo apt-get install redis-server
sudo systemctl start redis-server
pip install redis
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ**:
- –î–æ–±–∞–≤–∏—Ç—å Redis –∫–ª–∏–µ–Ω—Ç –≤ `__init__`
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `similarity_search`
- TTL –∫–µ—à–∞: 1 —á–∞—Å –¥–ª—è embeddings

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: 80%+ –∫–µ—à-–ø–æ–ø–∞–¥–∞–Ω–∏–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

#### 1.3 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å RAG pipeline (—ç–∫–æ–Ω–æ–º–∏—è 2-3 —Å–µ–∫)
**–§–∞–π–ª**: `app/backend/rag/agent.py`

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ embedding –∑–∞–ø—Ä–æ—Å—ã
- –î–≤–æ–π–Ω—ã–µ LLM –∑–∞–ø—Ä–æ—Å—ã (primary + fallback)
- –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–†–µ—à–µ–Ω–∏—è**:
- –û–¥–∏–Ω embedding –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 3-4
- –£–±—Ä–∞—Ç—å fallback –ª–æ–≥–∏–∫—É –¥–ª—è streaming
- –°–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å 10 –¥–æ 5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –≠–¢–ê–ü 2: –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø (4-6 —á–∞—Å–æ–≤)

#### 2.1 –û–±–Ω–æ–≤–∏—Ç—å ChromaDB (—ç–∫–æ–Ω–æ–º–∏—è 0.5-1 —Å–µ–∫)
**–§–∞–π–ª**: `app/backend/rag/agent.py`

```bash
pip uninstall langchain-community
pip install langchain-chroma
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```python
# –ë–´–õ–û:
from langchain_community.vectorstores import Chroma

# –°–¢–ê–õ–û:
from langchain_chroma import Chroma
```

#### 2.2 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã (—ç–∫–æ–Ω–æ–º–∏—è 1-2 —Å–µ–∫)
**–§–∞–π–ª**: `config/prompts.json`

- –°–æ–∫—Ä–∞—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –Ω–∞ 30-50%
- –£–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è streaming

#### 2.3 –î–æ–±–∞–≤–∏—Ç—å connection pooling
**–§–∞–π–ª—ã**: `app/backend/services/asr_service.py`, `yandex_tts_service.py`

- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- Async session pooling
- Timeout –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –≠–¢–ê–ü 3: –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨ (2-4 —á–∞—Å–∞)

#### 3.1 –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
**–§–∞–π–ª**: `app/backend/asterisk/stasis_handler.py`

- –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ SQLite
- Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### 3.2 Error handling –∏ fallback
- Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- Circuit breaker pattern
- Health checks

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í—Ä–µ–º—è | –ü—Ä–æ–±–ª–µ–º—ã |
|-----------|-------|----------|
| ASR | 2.0—Å | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| AI Streaming | 9.5—Å | ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ |
| TTS | 0.5—Å | ‚ùå HTTP fallback |
| **–ò–¢–û–ì–û** | **12.0—Å** | ‚ùå –ù–µ–ø—Ä–∏–µ–º–ª–µ–º–æ |

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í—Ä–µ–º—è | –£–ª—É—á—à–µ–Ω–∏—è |
|-----------|-------|-----------|
| ASR | 2.0—Å | ‚úÖ –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| AI Streaming | 2.5—Å | ‚úÖ –ö–µ—à + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |
| TTS | 0.1—Å | ‚úÖ gRPC —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–ò–¢–û–ì–û** | **4.6—Å** | ‚úÖ –ü—Ä–∏–µ–º–ª–µ–º–æ |

### –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **–û–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞**: ‚â§ 3 —Å–µ–∫—É–Ω–¥—ã
- **Cache hit rate**: ‚â• 80% –¥–ª—è embeddings
- **gRPC TTS success rate**: ‚â• 95%
- **Error rate**: ‚â§ 1%

## üö® –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –ù–µ–¥–µ–ª—è 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **–î–µ–Ω—å 1-2**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å gRPC TTS
- **–î–µ–Ω—å 3-4**: –î–æ–±–∞–≤–∏—Ç—å Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–î–µ–Ω—å 5**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å RAG pipeline

### –ù–µ–¥–µ–ª—è 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- **–î–µ–Ω—å 1-2**: –û–±–Ω–æ–≤–∏—Ç—å ChromaDB
- **–î–µ–Ω—å 3-4**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∏ connection pooling
- **–î–µ–Ω—å 5**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ù–µ–¥–µ–ª—è 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
- **–î–µ–Ω—å 1-2**: –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–î–µ–Ω—å 3-4**: Error handling –∏ fallback
- **–î–µ–Ω—å 5**: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–ï–ú–ö–ò

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [ ] –û–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ ‚â§ 3 —Å–µ–∫—É–Ω–¥—ã
- [ ] gRPC TTS —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- [ ] –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ embedding –∑–∞–ø—Ä–æ—Å—ã
- [ ] –ù–µ—Ç deprecation warnings
- [ ] –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- [ ] Cache hit rate ‚â• 80%
- [ ] Error rate ‚â§ 1%
- [ ] Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üîß –ì–û–¢–û–í–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã:
```bash
cd /root/Asterisk_bot/asterisk-vox-bot
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt-get install redis-server
sudo systemctl start redis-server
pip install redis grpcio-tools langchain-chroma psutil

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ChromaDB
pip uninstall langchain-community
pip install langchain-chroma
```

### –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è proto —Ñ–∞–π–ª–æ–≤:
```bash
cd app/backend/services/
python -m grpc_tools.protoc \
    --python_out=. \
    --grpc_python_out=. \
    yandex/cloud/ai/tts/v3/*.proto
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis
redis-cli ping

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Asterisk
sudo systemctl status asterisk

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl status metrotech-bot
```

## üìã –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–Ø

### –í—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏:
1. **gRPC proto —Ñ–∞–π–ª—ã**: –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
2. **Redis –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ –∏ CPU
3. **ChromaDB –º–∏–≥—Ä–∞—Ü–∏—è**: –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### –ú–∏—Ç–∏–≥–∞—Ü–∏—è:
- –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å rollback –ø–ª–∞–Ω–æ–º
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–ø–∏–∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω**: 04.09.2025  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: 4x —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ (12—Å ‚Üí 3—Å)  
**–ö–æ–º–∞–Ω–¥–∞**: AI Assistant + User  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
